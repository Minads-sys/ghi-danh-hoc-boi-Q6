<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LỚP BƠI QUẬN 6</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện SheetJS (Excel Export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Tải thư viện QRCode.js (Tạo QR) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* CSS cho message box tùy chỉnh (thay thế alert()) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .message-box {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .message-box.hide {
            animation: fadeOut 0.3s ease-in forwards;
        }
        
        /* CSS cho Modal (Sửa học viên) */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }

        /* CSS để ẩn/hiện các mục chỉ dành cho Admin */
        .admin-only {
            display: none; /* Ẩn các nút Sửa/Xóa mặc định */
        }
        body.admin-view .admin-only {
            display: table-cell; /* Hiện trong bảng */
        }
        /* (MỚI) CSS cho các nút admin không nằm trong bảng */
        body.admin-view .admin-only-inline {
            display: inline-block;
        }
        /* Class riêng cho nút gạt role */
        body.admin-view .admin-only-flex {
            display: flex;
        }

        /* CSS cho bản in */
        @media print {
            body {
                margin: 0;
                padding: 0;
                font-family: 'Arial', sans-serif;
            }
            .no-print {
                display: none !important;
            }
            .print-container {
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
            }
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .print-table th, .print-table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            .print-table th {
                background-color: #f4f4f4;
            }
            .print-header {
                text-align: center;
                margin-bottom: 30px;
            }
            .print-header h1 {
                margin: 0;
                font-size: 24px;
            }
            .print-header p {
                margin: 5px 0;
                font-size: 14px;
            }
            .print-qr {
                text-align: center;
                margin-top: 20px;
            }
            .print-qr img {
                width: 150px;
                height: 150px;
            }
            .print-footer {
                margin-top: 50px;
                display: flex;
                justify-content: space-between;
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen no-print">

    <!-- Màn hình đăng nhập -->
    <div id="loginView" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">HBA Q6 Login</h2>
            <div class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="loginEmail" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- (SỬA) Thêm wrapper cho Mật khẩu + Icon -->
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">Mật khẩu</label>
                    <div class="relative mt-1">
                        <input type="password" id="loginPassword" class="block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10">
                        <button id="togglePassword" type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                            <!-- Icon Mắt (SVG) -->
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                              <path fill-rule="evenodd" d="M.458 10C1.73 5.943 5.522 3 10 3s8.27 2.943 9.542 7c-1.27 4.057-5.064 7-9.542 7S1.73 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                            </svg>
                            <!-- Icon Mắt Gạch (SVG) - Mặc định ẩn -->
                            <svg id="eyeOffIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.27 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074L3.707 2.293zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                              <path d="M2 10s3.939-7 8-7 8 7 8 7-3.939 7-8 7-8-7-8-7zm7.886-3.074A4.008 4.008 0 0114 10a4 4 0 01-4 4 3.987 3.987 0 01-3.232-1.678l9.118-9.118zM10 14a4 4 0 100-8 4 4 0 000 8z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="loginButton" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                    Đăng Nhập
                </button>
            </div>
        </div>
    </div>

    <!-- Wrapper cho nội dung chính của App (ẩn khi chưa login) -->
    <div id="appWrapper" class="hidden">
        <!-- Thanh Header -->
        <header class="bg-white shadow-md no-print">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-blue-700">ĐĂNG KÝ LỚP BƠI QUẬN 6</h1>
                    <p class="text-sm text-gray-500">Chào, <span id="userIdDisplay" class="font-medium">...</span></p>
                </div>
                <div class="flex items-center">
                    <!-- (SỬA) Ẩn mặc định, chỉ admin mới thấy -->
                    <div id="roleSwitcherWrapper" class="relative hidden">
                        <select id="roleSwitcher" class="appearance-none block w-full bg-gray-100 border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-blue-500">
                            <option value="leTan">Giao diện: Lễ Tân</option>
                            <option value="admin">Giao diện: Quản Lý</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                        </div>
                    </div>
                    <!-- Nút Đăng xuất -->
                    <button id="logoutButton" class="ml-4 bg-red-500 text-white py-2 px-4 rounded-lg shadow-md text-sm font-semibold hover:bg-red-600">
                        Đăng Xuất
                    </button>
                </div>
            </nav>
        </header>

        <!-- Nội dung chính -->
        <main class="container mx-auto p-6">

            <!-- ===== VIEW LỄ TÂN (INPUT_FORM) ===== -->
            <div id="leTanView">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Cột 1: Form Ghi Danh -->
                    <div class="lg:col-span-2">
                        <div class="bg-white p-8 rounded-xl shadow-lg">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Phiếu Ghi Danh Học Viên</h2>
                            
                            <!-- Form nhập liệu -->
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="tenHV" class="block text-sm font-medium text-gray-700">Họ tên học viên</label>
                                    <input type="text" id="tenHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập đầy đủ họ và tên">
                                </div>
                                
                                <!-- Hàng Điện thoại + Mã thẻ -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="dienThoai" class="block text-sm font-medium text-gray-700">Điện thoại</label>
                                        <input type="tel" id="dienThoai" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="SĐT Ba/Mẹ hoặc HV">
                                    </div>
                                    <div>
                                        <label for="maTheHV" class="block text-sm font-medium text-gray-700">Mã Thẻ HV</label>
                                        <input type="text" id="maTheHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="nhập Mã QR trên thẻ màu xanh">
                                    </div>
                                </div>
                                
                                <!-- Hàng Số Phiếu Thu -->
                                <div>
                                    <label for="soPhieuThu" class="block text-sm font-medium text-gray-700">Số Phiếu Thu</label>
                                    <input type="text" id="soPhieuThu" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nhập số phiếu thu">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="goiHoc" class="block text-sm font-medium text-gray-700">Gói Học</label>
                                        <select id="goiHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">-- Chọn gói học --</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="caHoc" class="block text-sm font-medium text-gray-700">Ca Học</label>
                                        <select id="caHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">-- Chọn ca học --</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <label class="block text-sm font-medium text-blue-700">HLV Được Gán (Tự động)</label>
                                        <span id="hlvDuocGan" class="mt-1 block text-lg font-bold text-blue-900">Vui lòng chọn Ca Học</span>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <label class="block text-sm font-medium text-green-700">Học Phí (Tự động)</label>
                                        <span id="hocPhiTuDong" class="mt-1 block text-lg font-bold text-green-900">0 VNĐ</span>
                                    </div>
                                </div>
                                
                                <!-- Ô Nhập học phí tùy chỉnh -->
                                <div>
                                    <label for="hocPhiTuyChinh" class="block text-sm font-medium text-gray-700">Nhập Học Phí (Gói Khác)</label>
                                    <input type="number" id="hocPhiTuyChinh" class="mt-1 block w-full px-4 py-3 border border-orange-400 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 hidden" placeholder="Nhập số tiền...">
                                </div>

                                <!-- Lý do thu khác -->
                                <div id="lyDoThuKhacWrapper" class="hidden">
                                    <label for="lyDoThuKhac" class="block text-sm font-medium text-gray-700">Lý do thu khác</label>
                                    <input type="text" id="lyDoThuKhac" class="mt-1 block w-full px-4 py-3 border border-orange-400 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="VD: Thu 1 buổi, thu 6 buổi...">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="thanhToan" class="block text-sm font-medium text-gray-700">Hình thức Thanh toán</label>
                                        <select id="thanhToan" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">-- Chọn hình thức --</option>
                                            <option value="Tiền mặt">Tiền mặt</option>
                                            <option value="Chuyển khoản">Chuyển khoản</option>
                                        </select>
                                    </div>
                                </div>

                            </div>
                            
                            <button id="ghiDanhButton" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                                <span id="ghiDanhText">Ghi Danh & In Phiếu</span>
                                <span id="ghiDanhLoading" class="hidden">Đang xử lý...</span>
                            </button>
                        </div>
                    </div>

                    <!-- Cột 2: Thống kê (Lễ Tân) -->
                    <div class="space-y-6">
                        <!-- Thống Kê Nhanh -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Thống Kê Nhanh</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center bg-blue-50 p-3 rounded-lg">
                                    <span class="text-sm font-medium text-blue-700">HV Mới Hôm Nay:</span>
                                    <span id="statTodayCount" class="text-lg font-bold text-blue-800">0</span>
                                </div>
                                <div class="flex justify-between items-center bg-green-50 p-3 rounded-lg">
                                    <span class="text-sm font-medium text-green-700">HV Mới Tuần Này:</span>
                                    <span id="statWeekCount" class="text-lg font-bold text-green-800">0</span>
                                </div>
                                <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-lg">
                                    <span class="text-sm font-medium text-indigo-700">HV Mới Tháng Này:</span>
                                    <span id="statMonthCount" class="text-lg font-bold text-indigo-800">0</span>
                                </div>
                                <!-- (MỚI) Doanh thu hôm nay -->
                                <div class="flex justify-between items-center bg-yellow-50 p-3 rounded-lg">
                                    <span class="text-sm font-medium text-yellow-700">Doanh Thu Hôm Nay:</span>
                                    <span id="todayRevenueHeader" class="text-lg font-bold text-yellow-800">0 VNĐ</span>
                                </div>
                            </div>
                        </div>

                        <!-- Báo Cáo Trong Ngày (Lễ Tân) -->
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Ghi Danh Trong Ngày</h3>
                                <button id="exportDailyExcelButton" class="bg-emerald-500 text-white py-2 px-3 rounded-lg shadow-md text-sm font-semibold hover:bg-emerald-600">
                                    Export Excel
                                </button>
                            </div>
                            <div class="overflow-y-auto max-h-[300px]">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên HV</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Học Phí</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HLV</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dailyReportTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Dữ liệu real-time -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ===== VIEW QUẢN LÝ (ADMIN) ===== -->
            <div id="adminView" class="hidden space-y-8">
                
                <!-- 1. Form Thêm HĐ Chỉ Định -->
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold text-red-700 mb-6">Thêm Hợp Đồng</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="adminTenHV" class="block text-sm font-medium text-gray-700">Tên Học Viên</label>
                            <input type="text" id="adminTenHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="adminDienThoai" class="block text-sm font-medium text-gray-700">Điện thoại</label>
                                <input type="tel" id="adminDienThoai" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                            </div>
                            <div>
                                <label for="adminMaTheHV" class="block text-sm font-medium text-gray-700">Mã Thẻ HV</label>
                                <input type="text" id="adminMaTheHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                            </div>
                        </div>

                        <div>
                            <label for="adminSoPhieuThu" class="block text-sm font-medium text-gray-700">Số Phiếu Thu</label>
                            <input type="text" id="adminSoPhieuThu" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="adminGoiHoc" class="block text-sm font-medium text-gray-700">Gói Học</label>
                                <select id="adminGoiHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                            </div>
                            <div>
                                <label for="adminCaHoc" class="block text-sm font-medium text-gray-700">Ca Học</label>
                                <select id="adminCaHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                            </div>
                        </div>

                        <div>
                            <label for="adminHocPhiTuyChinh" class="block text-sm font-medium text-gray-700">Nhập Học Phí (Gói Khác)</label>
                            <input type="number" id="adminHocPhiTuyChinh" class="mt-1 block w-full px-4 py-3 border border-orange-400 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 hidden" placeholder="Nhập số tiền...">
                        </div>

                        <div id="adminLyDoThuKhacWrapper" class="hidden">
                            <label for="adminLyDoThuKhac" class="block text-sm font-medium text-gray-700">Lý do thu khác</label>
                            <input type="text" id="adminLyDoThuKhac" class="mt-1 block w-full px-4 py-3 border border-orange-400 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="adminHlvChon" class="block text-sm font-medium text-gray-700">Chỉ định HLV</label>
                                <select id="adminHlvChon" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                            </div>
                            <div>
                                <label for="adminLoaiHD" class="block text-sm font-medium text-gray-700">Loại Hợp Đồng</label>
                                <select id="adminLoaiHD" class="mt-1 block w-full px-4 py-3 border border-red-500 bg-red-50 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="Chỉ Định">Chỉ Định</option>
                                    <option value="Thường">Thường (Admin)</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="adminThanhToan" class="block text-sm font-medium text-gray-700">Hình thức Thanh toán</label>
                                <select id="adminThanhToan" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                                    <option value="Tiền mặt">Tiền mặt</option>
                                    <option value="Chuyển khoản">Chuyển khoản</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label for="adminGhiChu" class="block text-sm font-medium text-gray-700">Ghi Chú</label>
                            <input type="text" id="adminGhiChu" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="HĐ chỉ định Thầy Ngọc...">
                        </div>
                        
                        <button id="adminAddButton" class="w-full bg-red-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-200">
                            Thêm Hợp Đồng (Admin)
                        </button>
                    </div>
                </div>

                <!-- 2. Báo Cáo Doanh Thu (REPORT) -->
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Báo Cáo Doanh Thu (Admin)</h2>
                    
                    <div class="flex flex-wrap items-end space-x-4 mb-6">
                        <div>
                            <label for="reportFilterType" class="block text-sm font-medium text-gray-700">Loại Báo Cáo</label>
                            <select id="reportFilterType" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="month">Theo Tháng</option>
                                <option value="today">Hôm Nay</option>
                                <option value="date">Theo Ngày Cụ Thể</option>
                                <option value="range">Theo Khoảng Thời Gian</option>
                            </select>
                        </div>

                        <div id="filterMonthControls">
                            <div class="flex space-x-4">
                                <div>
                                    <label for="reportMonth" class="block text-sm font-medium text-gray-700">Tháng</label>
                                    <select id="reportMonth" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </select>
                                </div>
                                <div>
                                    <label for="reportYear" class="block text-sm font-medium text-gray-700">Năm</label>
                                    <input type="number" id="reportYear" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" min="2020" max="2030">
                                </div>
                            </div>
                        </div>

                        <div id="filterDateControls" class="hidden">
                            <div>
                                <label for="reportDate" class="block text-sm font-medium text-gray-700">Chọn Ngày</label>
                                <input type="date" id="reportDate" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div id="filterRangeControls" class="hidden">
                            <div class="flex space-x-4">
                                <div>
                                    <label for="reportDateStart" class="block text-sm font-medium text-gray-700">Từ Ngày</label>
                                    <input type="date" id="reportDateStart" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="reportDateEnd" class="block text-sm font-medium text-gray-700">Đến Ngày</label>
                                    <input type="date" id="reportDateEnd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <button id="viewReportButton" class="self-end bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Xem Báo Cáo
                        </button>

                        <div class="relative inline-block text-left self-end">
                            <button id="tacVuKhacButton" class="bg-gray-700 text-white py-3 px-6 rounded-lg shadow-lg font-semibold hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                <span>Tác vụ khác...</span>
                                <svg class="inline w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                            <div id="tacVuKhacMenu" class="absolute right-0 mt-0 pt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10 hidden">
                                <div class="py-1" role="menu" aria-orientation="vertical">
                                    <a href="#" id="printReportButton" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">In Báo Cáo (Đang xem)</a>
                                    <a href="#" id="exportExcelButton" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Export Excel (Báo cáo)</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HLV Phụ Trách</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng HV Mới</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng Doanh Thu (100%)</th>
                                    <!-- (SỬA) Thêm ID cho các tiêu đề tỉ lệ -->
                                    <th scope="col" id="hbaPercentHeader" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HBA Nhận (60%)</th>
                                    <th scope="col" id="hlvPercentHeader" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng Hoa Hồng HLV (40%)</th>
                                    <th scope="col" id="taxPercentHeader" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thuế TNCN (10%)</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HLV Thực Nhận</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Chưa có dữ liệu. Vui lòng chọn tháng/năm và nhấn xem.</td></tr>
                            </tbody>
                            <tfoot class="bg-gray-100 font-bold">
                                <tr id="reportTableFooter" class="hidden">
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- 3. Lịch sử Ghi Danh (DATABASE) -->
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">Lịch sử Ghi Danh (Real-time)</h2>
                        <button id="exportHistoryExcelButton" class="bg-emerald-500 text-white py-2 px-4 rounded-lg shadow-md text-sm font-semibold hover:bg-emerald-600 admin-only-inline" style="display: none;">
                            Export Excel (Lịch sử)
                        </button>
                    </div>
                    <div class="overflow-x-auto max-h-[600px]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số Phiếu Thu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã Thẻ HV</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên Học Viên</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Điện thoại</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HLV Phụ Trách</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gói Học</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Học Phí</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loại HĐ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thanh Toán</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lý Do Thu Khác</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ghi Chú</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 4. Quản lý HLV (SETTINGS) -->
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Quản lý HLV (Settings)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg">
                        <div>
                            <label for="hlvTen" class="block text-sm font-medium text-gray-700">Tên HLV</label>
                            <input type="text" id="hlvTen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Thầy Nguyễn Văn A">
                        </div>
                        <div>
                            <label for="hlvCa" class="block text-sm font-medium text-gray-700">Ca Dạy</label>
                            <select id="hlvCa" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                <option>Sáng</option>
                                <option>Chiều</option>
                            </select>
                        </div>
                        <div>
                            <label for="hlvUuTien" class="block text-sm font-medium text-gray-700">Thứ tự Ưu tiên</label>
                            <input type="number" id="hlvUuTien" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="1">
                        </div>
                        <button id="saveHlvButton" class="self-end bg-green-600 text-white py-2 px-4 rounded-lg shadow font-semibold hover:bg-green-700">
                            Thêm/Cập nhật HLV
                        </button>
                        <input type="hidden" id="hlvEditId">
                    </div>

                    <div class="overflow-x-auto max-h-[400px]">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên HLV</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ca Dạy</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ưu Tiên</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="hlvSettingsTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 5. Import Excel (Admin) -->
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto mt-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Import Dữ Liệu (Admin)</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="excelImportFile" class="block text-sm font-medium text-gray-700">Chọn file Excel (.xlsx, .xls)</label>
                            <input type="file" id="excelImportFile" class="mt-1 block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-blue-50 file:text-blue-700
                                hover:file:bg-blue-100"
                                accept=".xlsx, .xls">
                        </div>
                        <p class="text-xs text-gray-600">
                            <strong>Lưu ý:</strong> Dữ liệu import sẽ bỏ qua luật chia lượt.
                            Các cột bắt buộc: <strong>tenHV, goiHoc, hocPhi, caHoc, hlvPhuTrach, loaiHD, thanhToan</strong>.
                            Các cột tùy chọn: <strong>ghiChu, dienThoai, maTheHV, soPhieuThu, lyDoThuKhac</strong>.
                        </p>
                        <button id="importExcelButton" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-purple-700">
                            <span id="importExcelText">Bắt đầu Import</span>
                            <span id="importExcelLoading" class="hidden">Đang xử lý, vui lòng chờ...</span>
                        </button>
                    </div>
                </div>

                <!-- 6. Cài đặt Thanh toán QR (SETTINGS) -->
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto mt-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Cài đặt Thanh toán QR (Admin)</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="qrBankName" class="block text-sm font-medium text-gray-700">Tên Ngân hàng (Vd: Vietinbank)</label>
                            <input type="text" id="qrBankName" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="qrBankBin" class="block text-sm font-medium text-gray-700">Bank BIN/Code (Vd: 970415 cho Vietinbank)</label>
                            <input type="text" id="qrBankBin" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="qrAccountNumber" class="block text-sm font-medium text-gray-700">Số Tài Khoản</label>
                            <input type="text" id="qrAccountNumber" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <div>
                            <label for="qrAccountName" class="block text-sm font-medium text-gray-700">Tên Chủ Tài Khoản</label>
                            <input type="text" id="qrAccountName" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                        <button id="saveQrButton" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-green-700">
                            Lưu Cài đặt QR
                        </button>
                    </div>
                </div>

                <!-- (MỚI) 7. Cài đặt Tỉ lệ Doanh thu (Admin) -->
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto mt-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Cài đặt Tỉ lệ Doanh thu (Admin)</h2>
                    <p class="text-sm text-gray-600 mb-4">Lưu ý: Tỉ lệ HLV = 100% - Tỉ lệ HBA.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="splitHbaPercent" class="block text-sm font-medium text-gray-700">Tỉ lệ HBA Nhận (%)</label>
                            <input type="number" id="splitHbaPercent" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" value="60">
                        </div>
                        <div>
                            <label for="splitTaxPercent" class="block text-sm font-medium text-gray-700">Thuế TNCN (%) (Tính trên hoa hồng HLV)</label>
                            <input type="number" id="splitTaxPercent" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" value="10">
                        </div>
                        <button id="saveSplitButton" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-green-700">
                            Lưu Cài đặt Tỉ lệ
                        </button>
                    </div>
                </div>

            </div> <!-- Kết thúc adminView -->
        </main>
    </div> <!-- Kết thúc appWrapper -->

    <!-- Modal Sửa Học Viên -->
    <div id="editStudentModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden" style="z-index: 100;">
        <div class="modal-content bg-white p-8 rounded-xl shadow-lg max-w-2xl w-full mx-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Chỉnh sửa Thông tin Học viên</h2>
            <input type="hidden" id="editStudentId">
            
            <div class="space-y-4">
                <div>
                    <label for="editTenHV" class="block text-sm font-medium text-gray-700">Tên Học Viên</label>
                    <input type="text" id="editTenHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editDienThoai" class="block text-sm font-medium text-gray-700">Điện thoại</label>
                        <input type="tel" id="editDienThoai" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="editMaTheHV" class="block text-sm font-medium text-gray-700">Mã Thẻ HV</label>
                        <input type="text" id="editMaTheHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                </div>

                <div>
                    <label for="editSoPhieuThu" class="block text-sm font-medium text-gray-700">Số Phiếu Thu</label>
                    <input type="text" id="editSoPhieuThu" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editGoiHoc" class="block text-sm font-medium text-gray-700">Gói Học</label>
                        <select id="editGoiHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm"></select>
                    </div>
                    <div>
                        <label for="editCaHoc" class="block text-sm font-medium text-gray-700">Ca Học</label>
                        <select id="editCaHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm"></select>
                    </div>
                </div>

                <div>
                    <label for="editHocPhiTuyChinh" class="block text-sm font-medium text-gray-700">Học Phí (Nếu là Gói Khác)</label>
                    <input type="number" id="editHocPhiTuyChinh" class="mt-1 block w-full px-4 py-3 border border-orange-400 rounded-lg shadow-sm hidden" placeholder="Nhập học phí tùy chỉnh...">
                </div>

                <div id="editLyDoThuKhacWrapper" class="hidden">
                    <label for="editLyDoThuKhac" class="block text-sm font-medium text-gray-700">Lý do thu khác</label>
                    <input type="text" id="editLyDoThuKhac" class="mt-1 block w-full px-4 py-3 border border-orange-400 rounded-lg shadow-sm">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editHlvChon" class="block text-sm font-medium text-gray-700">HLV Phụ Trách</label>
                        <select id="editHlvChon" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm"></select>
                    </div>
                    <div>
                        <label for="editLoaiHD" class="block text-sm font-medium text-gray-700">Loại Hợp Đồng</label>
                        <select id="editLoaiHD" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                            <option value="Chỉ Định">Chỉ Định</option>
                            <option value="Thường">Thường</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editThanhToan" class="block text-sm font-medium text-gray-700">Hình thức Thanh toán</label>
                        <select id="editThanhToan" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                            <option value="Tiền mặt">Tiền mặt</option>
                            <option value="Chuyển khoản">Chuyển khoản</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="editGhiChu" class="block text-sm font-medium text-gray-700">Ghi Chú</label>
                    <input type="text" id="editGhiChu" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                </div>
                
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="cancelEditButton" class="bg-gray-500 text-white py-2 px-6 rounded-lg shadow font-semibold hover:bg-gray-600">
                        Hủy
                    </button>
                    <button id="updateStudentButton" class="bg-blue-600 text-white py-2 px-6 rounded-lg shadow font-semibold hover:bg-blue-700">
                        Lưu Thay Đổi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box (Modal) -->
    <div id="messageBox" class="message-box hidden fixed top-10 right-10 max-w-sm p-4 rounded-lg shadow-lg" style="z-index: 200;">
        <p id="messageText"></p>
        <button id="closeMessage" class="absolute top-1 right-2 text-lg font-bold">&times;</button>
    </div>

    <!-- ===== SCRIPT LOGIC ===== -->
    <script type="module">
        /* ===== 1. FIREBASE IMPORTS ===== */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signInWithEmailAndPassword, // Thêm
            signOut // Thêm
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs,
            getDoc,
            doc,
            updateDoc,
            deleteDoc,
            setDoc,
            query, 
            where, 
            Timestamp, 
            onSnapshot,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // (SỬA) Bọc toàn bộ code trong DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {

            /* ===== 2. CÀI ĐẶT CỐ ĐỊNH ===== */
            const ADMIN_USER_ID_LIST = ["EQ2omFVthCXieS6VzfzdZ13fWwX2"]; ["nJiQ3pfAEfVnUnjrhSPCIKbVS4y1"];
            let HLV_SETTINGS_LIST = []; 
            let PAYMENT_SETTINGS = {}; 

            const GOI_HOC_SETTINGS = [
                { ten: "12 buổi (1.500.000)", hocPhi: 1500000 },
                { ten: "24 buổi (3.000.000)", hocPhi: 3000000 },
                { ten: "Gói khác (Tùy chỉnh)", hocPhi: 0 } // (MỚI) Thêm gói tùy chỉnh
            ];
            const CA_HOC_SETTINGS = ["Sáng", "Chiều"];

            /* ===== 3. BIẾN TOÀN CỤC VÀ KHỞI TẠO FIREBASE ===== */
            let app, auth, db, dbHocVienCollection, dbHlvCollection, dbPaymentSettingsDoc;
            let currentUserId = null;
            let isAdmin = false; 
            let allStudentsCache = []; 
            let currentReportCache = []; 
            let dailyReportCache = []; 
            let unsubscribeHocVien = null; // (MỚI) Biến để giữ listener
            let messageTimer; 
            
            // (MỚI) Biến cho cài đặt tỉ lệ
            let REVENUE_SPLIT_SETTINGS = {}; 

            // (SỬA) Lấy DOM elements (chỉ những cái cần ngay lập tức)
            const loginView = document.getElementById('loginView');
            const appWrapper = document.getElementById('appWrapper');
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginButton = document.getElementById('loginButton');
            const togglePasswordButton = document.getElementById('togglePassword');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const closeMessageButton = document.getElementById('closeMessage');

            // Config Firebase
            const firebaseConfig = {
              apiKey: "AIzaSyB_a8W1Qc0aEmKFILX3IZGjnTsYoEVjKGI",
              authDomain: "ghi-danh-hoc-boi-q6.firebaseapp.com",
              projectId: "ghi-danh-hoc-boi-q6",
              storageBucket: "ghi-danh-hoc-boi-q6.firebasestorage.app",
              messagingSenderId: "32346881439",
              appId: "1:32346881439:web:b7b60da3cf510ec7a291aa",
              measurementId: "G-B43NG2KHD1"
            };

            // Đường dẫn collection
            const hocVienCollectionPath = `hoc_vien_db`;
            const hlvCollectionPath = `hlv_settings`;
            const paymentSettingsDocPath = `app_settings/payment_info`; 
            
            // (MỚI) Đường dẫn cho cài đặt tỉ lệ
            const revenueSplitDocPath = `app_settings/revenue_split`;
            let dbRevenueSplitDoc;

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); 

                dbHocVienCollection = collection(db, hocVienCollectionPath);
                dbHlvCollection = collection(db, hlvCollectionPath);
                dbPaymentSettingsDoc = doc(db, paymentSettingsDocPath);
                
                // (MỚI) Khởi tạo doc tỉ lệ
                dbRevenueSplitDoc = doc(db, revenueSplitDocPath);

                // Gán sự kiện cho Message Box (luôn chạy)
                closeMessageButton.addEventListener('click', () => messageBox.classList.add('hide'));

                // (SỬA) Gán sự kiện cho màn hình Login (luôn chạy)
                loginButton.addEventListener('click', handleLogin);
                togglePasswordButton.addEventListener('click', togglePasswordVisibility);
                loginEmailInput.addEventListener('keydown', handleLoginKeyDown);
                loginPasswordInput.addEventListener('keydown', handleLoginKeyDown);

                // Lắng nghe thay đổi trạng thái Auth
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // === USER ĐÃ ĐĂNG NHẬP ===
                        console.log("User đã đăng nhập:", user.uid, user.email);
                        currentUserId = user.uid;
                        
                        // Hiển thị App, Ẩn Login
                        appWrapper.classList.remove('hidden');
                        loginView.classList.add('hidden');
                        
                        // Kiểm tra Admin
                        if (ADMIN_USER_ID_LIST.includes(currentUserId)) {
                            isAdmin = true;
                            document.getElementById('roleSwitcherWrapper').classList.remove('hidden');
                            console.log("Quyền Admin được cấp.");
                        } else {
                            isAdmin = false;
                            document.getElementById('roleSwitcherWrapper').classList.add('hidden');
                            console.log("Quyền Lễ tân.");
                        }
                        
                        document.getElementById('userIdDisplay').textContent = user.email;
                        
                        // Thiết lập giao diện (Lễ tân/Admin)
                        setupInitialView();
                        
                        // Tải settings và bắt đầu nghe real-time
                        loadAppSettingsAndListeners();

                    } else {
                        // === USER CHƯA ĐĂNG NHẬP ===
                        console.log("User chưa đăng nhập. Hiển thị màn hình Login.");
                        appWrapper.classList.add('hidden');
                        loginView.classList.remove('hidden');
                        
                        // (MỚI) Dọn dẹp
                        currentUserId = null;
                        isAdmin = false;
                        
                        // (MỚI) Tắt listener cũ nếu có
                        if (unsubscribeHocVien) {
                            unsubscribeHocVien();
                            unsubscribeHocVien = null;
                            console.log("Đã tắt listener real-time.");
                        }
                    }
                });

            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                showMessage("Lỗi khởi tạo hệ thống. Vui lòng tải lại trang.", "error");
            }

            /* ===== 4. HÀM XỬ LÝ AUTH (Đăng nhập/thoát) ===== */

            function handleLoginKeyDown(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            }

            function togglePasswordVisibility() {
                const isPassword = loginPasswordInput.type === 'password';
                loginPasswordInput.type = isPassword ? 'text' : 'password';
                eyeIcon.classList.toggle('hidden', isPassword);
                eyeOffIcon.classList.toggle('hidden', !isPassword);
            }

            async function handleLogin() {
                const email = loginEmailInput.value.trim();
                const password = loginPasswordInput.value.trim(); 

                if (!email || !password) {
                    showMessage("Vui lòng nhập Email và Mật khẩu.", "warning");
                    return;
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged sẽ tự động xử lý việc hiển thị app
                    showMessage("Đăng nhập thành công!", "success");
                } catch (error) {
                    console.error("--- LỖI ĐĂNG NHẬP CHI TIẾT ---", error);
                    let msg = "Lỗi đăng nhập không xác định.";
                    if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                        msg = "Sai Email hoặc Mật khẩu.";
                    } else if (error.code === 'auth/network-request-failed') {
                        msg = "Lỗi mạng, không thể kết nối đến server.";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        msg = "Phương thức đăng nhập Email/Pass chưa được bật trên Firebase.";
                    }
                    showMessage(msg, "error");
                }
            }

            async function handleLogout() {
                // (SỬA) Tắt listener trước khi logout
                if (unsubscribeHocVien) {
                    unsubscribeHocVien();
                    unsubscribeHocVien = null;
                    console.log("Đã tắt listener real-time trước khi logout.");
                }

                try {
                    await signOut(auth);
                    // onAuthStateChanged sẽ tự động xử lý việc hiển thị màn hình login
                    showMessage("Đã đăng xuất.", "success");
                } catch (error) {
                    console.error("Lỗi đăng xuất:", error);
                    showMessage("Lỗi khi đăng xuất.", "error");
                }
            }

            /* ===== 5. HÀM KHỞI TẠO APP (Sau khi login) ===== */

            // (MỚI) Hàm này chỉ chạy 1 lần sau khi login
            async function loadAppSettingsAndListeners() {
                try {
                    // 1. Load HLV Settings
                    const hlvSnapshot = await getDocs(query(dbHlvCollection));
                    HLV_SETTINGS_LIST = []; 
                    hlvSnapshot.forEach((doc) => {
                        HLV_SETTINGS_LIST.push({ id: doc.id, ...doc.data() });
                    });
                    console.log("Loaded HLV Settings:", HLV_SETTINGS_LIST);
                    HLV_SETTINGS_LIST.sort((a, b) => a.ca.localeCompare(b.ca) || a.uuTien - b.uuTien);

                    // 2. Load Payment Settings
                    const paymentSnapshot = await getDoc(dbPaymentSettingsDoc);
                    if (paymentSnapshot.exists()) {
                        PAYMENT_SETTINGS = paymentSnapshot.data();
                        console.log("Loaded Payment Settings:", PAYMENT_SETTINGS);
                    } else {
                        console.log("Không tìm thấy payment settings, dùng default.");
                        PAYMENT_SETTINGS = {
                            bankName: "Vietinbank",
                            bankBin: "970415",
                            accountNumber: "0938099675",
                            accountName: "TRUONG HY MINH"
                        };
                        await setDoc(dbPaymentSettingsDoc, PAYMENT_SETTINGS, { merge: true });
                    }

                    // (MỚI) 3. Load Revenue Split Settings
                    const splitSnapshot = await getDoc(dbRevenueSplitDoc);
                    if (splitSnapshot.exists()) {
                        REVENUE_SPLIT_SETTINGS = splitSnapshot.data();
                        console.log("Loaded Revenue Split Settings:", REVENUE_SPLIT_SETTINGS);
                    } else {
                        console.log("Không tìm thấy revenue split settings, dùng default.");
                        REVENUE_SPLIT_SETTINGS = {
                            hba: 60, // HBA nhận 60%
                            tax: 10  // Thuế 10%
                        };
                        await setDoc(dbRevenueSplitDoc, REVENUE_SPLIT_SETTINGS, { merge: true });
                    }

                    // (SỬA) 4. Khởi tạo UI (Điền dropdowns, gán sự kiện)
                    initializeUI();
                    renderHlvSettingsTable(); 

                    // (SỬA) 5. Bắt đầu lắng nghe dữ liệu học viên (CHỈ KHI SETTINGS ĐÃ SẴN SÀNG)
                    startRealtimeListener();

                } catch (error) {
                    console.error("Lỗi nghiêm trọng khi tải settings:", error);
                    showMessage("Lỗi tải cấu hình HLV/Thanh toán. App không thể chạy.", "error");
                }
            }

            // (SỬA) Hàm này gán các sự kiện cho App
            function initializeUI() {
                // (SỬA) THÊM DÒNG NÀY VÀO ĐẦU HÀM
                document.getElementById('logoutButton').addEventListener('click', handleLogout);

                // Lấy DOM elements (của App)
                const roleSwitcher = document.getElementById('roleSwitcher');
                
                // Lễ tân
                const goiHocSelect = document.getElementById('goiHoc');
                const caHocSelect = document.getElementById('caHoc');
                const hocPhiTuyChinhInput = document.getElementById('hocPhiTuyChinh');
                const ghiDanhButton = document.getElementById('ghiDanhButton');
                const exportDailyExcelButton = document.getElementById('exportDailyExcelButton');

                // Admin
                const adminGoiHocSelect = document.getElementById('adminGoiHoc');
                const adminHocPhiTuyChinhInput = document.getElementById('adminHocPhiTuyChinh');
                const adminAddButton = document.getElementById('adminAddButton');
                const reportFilterType = document.getElementById('reportFilterType');
                const viewReportButton = document.getElementById('viewReportButton');
                const printReportButton = document.getElementById('printReportButton'); 
                const exportExcelButton = document.getElementById('exportExcelButton'); 
                
                const exportHistoryExcelButton = document.getElementById('exportHistoryExcelButton');
                
                /* (SỬA) Thêm nút Tác Vụ Khác */
                const tacVuKhacButton = document.getElementById('tacVuKhacButton');
                const tacVuKhacMenu = document.getElementById('tacVuKhacMenu');
                
                // Settings
                const historyTableBody = document.getElementById('historyTableBody');
                const hlvSettingsTableBody = document.getElementById('hlvSettingsTableBody');
                const saveHlvButton = document.getElementById('saveHlvButton');
                const saveQrButton = document.getElementById('saveQrButton');
                const importExcelButton = document.getElementById('importExcelButton'); 
                
                // (MỚI) Lấy DOM Cài đặt Tỉ lệ
                const saveSplitButton = document.getElementById('saveSplitButton');
                
                // Modal
                const editStudentModal = document.getElementById('editStudentModal');
                const updateStudentButton = document.getElementById('updateStudentButton');
                const cancelEditButton = document.getElementById('cancelEditButton');
                const editGoiHocSelect = document.getElementById('editGoiHoc');
                const editCaHocSelect = document.getElementById('editCaHoc');
                const editHlvChonSelect = document.getElementById('editHlvChon');
                const editHocPhiTuyChinhInput = document.getElementById('editHocPhiTuyChinh');

                // --- Điền Dropdowns ---
                const goiHocOptions = GOI_HOC_SETTINGS.map(goi => 
                    `<option value="${goi.ten}" data-hocphi="${goi.hocPhi}">${goi.ten}</option>`
                ).join('');
                goiHocSelect.innerHTML = '<option value="">-- Chọn gói học --</option>' + goiHocOptions;
                adminGoiHocSelect.innerHTML = '<option value="">-- Chọn gói học --</option>' + goiHocOptions;
                editGoiHocSelect.innerHTML = '<option value="">-- Chọn gói học --</option>' + goiHocOptions;

                const caHocOptions = CA_HOC_SETTINGS.map(ca => `<option value="${ca}">${ca}</option>`).join('');
                caHocSelect.innerHTML = '<option value="">-- Chọn ca học --</option>' + caHocOptions;
                document.getElementById('adminCaHoc').innerHTML = '<option value="">-- Chọn ca học --</option>' + caHocOptions;
                editCaHocSelect.innerHTML = '<option value="">-- Chọn ca học --</option>' + caHocOptions;

                const hlvOptions = HLV_SETTINGS_LIST.map(hlv => `<option value="${hlv.ten}">${hlv.ten}</option>`).join('');
                document.getElementById('adminHlvChon').innerHTML = '<option value="">-- Chọn HLV --</option>' + hlvOptions;
                editHlvChonSelect.innerHTML = '<option value="">-- Chọn HLV --</option>' + hlvOptions;

                // Điền QR Settings
                document.getElementById('qrBankName').value = PAYMENT_SETTINGS.bankName || "";
                document.getElementById('qrBankBin').value = PAYMENT_SETTINGS.bankBin || "";
                document.getElementById('qrAccountNumber').value = PAYMENT_SETTINGS.accountNumber || "";
                document.getElementById('qrAccountName').value = PAYMENT_SETTINGS.accountName || "";

                // (MỚI) Điền Revenue Split Settings
                document.getElementById('splitHbaPercent').value = REVENUE_SPLIT_SETTINGS.hba || 60;
                document.getElementById('splitTaxPercent').value = REVENUE_SPLIT_SETTINGS.tax || 10;

                // Điền Tháng/Năm cho Report
                const reportMonthSelect = document.getElementById('reportMonth');
                const reportYearInput = document.getElementById('reportYear');
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                reportMonthSelect.innerHTML = ""; // Xóa cũ
                for (let i = 1; i <= 12; i++) {
                    reportMonthSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>Tháng ${i}</option>`;
                }
                reportYearInput.value = currentYear;

                // --- Gán sự kiện ---
                roleSwitcher.addEventListener('change', toggleView);
                goiHocSelect.addEventListener('change', updateHocPhi);
                caHocSelect.addEventListener('change', updateHocPhi);
                ghiDanhButton.addEventListener('click', handleGhiDanhAndPrint); 
                exportDailyExcelButton.addEventListener('click', handleExportDailyExcel);

                adminGoiHocSelect.addEventListener('change', updateAdminHocPhi);
                adminAddButton.addEventListener('click', handleAdminAdd);
                viewReportButton.addEventListener('click', handleViewReport);
                printReportButton.addEventListener('click', handlePrintReport);
                exportExcelButton.addEventListener('click', handleExportExcel);
                exportHistoryExcelButton.addEventListener('click', handleExportExcel); // (MỚI) Gán sự kiện
                reportFilterType.addEventListener('change', toggleReportFilter); 

                /* (SỬA) Gán sự kiện click cho Tác Vụ Khác */
                if (tacVuKhacButton) {
                    tacVuKhacButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // Ngăn click lan ra window
                        tacVuKhacMenu.classList.toggle('hidden');
                    });
                }

                saveHlvButton.addEventListener('click', handleSaveHlv);
                saveQrButton.addEventListener('click', handleSaveQr);
                
                // (MỚI) Gán sự kiện cho Cài đặt Tỉ lệ
                saveSplitButton.addEventListener('click', handleSaveRevenueSplit);
                
                importExcelButton.addEventListener('click', handleImportExcel); 
                updateStudentButton.addEventListener('click', handleUpdateStudent);
                cancelEditButton.addEventListener('click', () => editStudentModal.classList.add('hidden'));

                // (MỚI) Sự kiện click cho bảng (Event Delegation)
                historyTableBody.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const id = target.dataset.id;
                    if (target.classList.contains('edit-btn')) handleShowEditModal(id);
                    else if (target.classList.contains('delete-btn')) handleDeleteStudent(id, target.dataset.name);
                });

                hlvSettingsTableBody.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    const id = target.dataset.id;
                    if (target.classList.contains('edit-hlv-btn')) handleEditHlv(id);
                    else if (target.classList.contains('delete-hlv-btn')) handleDeleteHlv(id);
                });

                // (MỚI) Sự kiện Gói Khác (Edit Modal)
                editGoiHocSelect.addEventListener('change', () => {
                    const selectedGoi = editGoiHocSelect.options[editGoiHocSelect.selectedIndex];
                    const hocPhi = Number(selectedGoi.dataset.hocphi);
                    const editLyDoThuKhacWrapper = document.getElementById('editLyDoThuKhacWrapper');
                    // Nếu chọn "Gói Khác", hiển thị ô nhập tùy chỉnh
                    if (hocPhi === 0) {
                        editHocPhiTuyChinhInput.classList.remove('hidden');
                        editLyDoThuKhacWrapper.classList.remove('hidden');
                    } else {
                        editHocPhiTuyChinhInput.classList.add('hidden');
                        editHocPhiTuyChinhInput.value = ""; // Xóa giá trị cũ
                        editLyDoThuKhacWrapper.classList.add('hidden');
                        document.getElementById('editLyDoThuKhac').value = "";
                    }
                });

                /* (SỬA) Click outside để đóng menu Tác Vụ Khác */
                window.addEventListener('click', (e) => {
                    if (tacVuKhacMenu && !tacVuKhacMenu.classList.contains('hidden')) {
                        if (!tacVuKhacButton.contains(e.target) && !tacVuKhacMenu.contains(e.target)) {
                            tacVuKhacMenu.classList.add('hidden');
                        }
                    }
                });
            }

            function setupInitialView() {
                let currentRole = 'leTan'; 
                if (isAdmin) {
                    currentRole = document.getElementById('roleSwitcher').value;
                }

                if (currentRole === 'admin') {
                    document.getElementById('leTanView').classList.add('hidden');
                    document.getElementById('adminView').classList.remove('hidden');
                    document.body.classList.add('admin-view'); 
                    document.body.classList.remove('le-tan-view');
                } else {
                    document.getElementById('leTanView').classList.remove('hidden');
                    document.getElementById('adminView').classList.add('hidden');
                    document.body.classList.remove('admin-view');
                    document.body.classList.add('le-tan-view'); 
                }
                
                const todayISO = new Date().toISOString().split('T')[0];
                document.getElementById('reportDate').value = todayISO;
                document.getElementById('reportDateStart').value = todayISO;
                document.getElementById('reportDateEnd').value = todayISO;
            }

            function toggleView() {
                setupInitialView();
            }

            /* ===== 6. LOGIC NGHIỆP VỤ (GHI DANH, TÍNH HLV) ===== */

            function updateHocPhi() {
                const goiHocSelect = document.getElementById('goiHoc');
                const hocPhiTuDongSpan = document.getElementById('hocPhiTuDong');
                const hocPhiTuyChinhInput = document.getElementById('hocPhiTuyChinh');
                const lyDoThuKhacWrapper = document.getElementById('lyDoThuKhacWrapper'); // (MỚI)
                
                const selectedGoiOption = goiHocSelect.options[goiHocSelect.selectedIndex];
                let hocPhi = 0;
                if (selectedGoiOption && selectedGoiOption.dataset.hocphi) {
                    hocPhi = Number(selectedGoiOption.dataset.hocphi);
                }
                
                // (MỚI) Xử lý Gói Khác
                if (hocPhi === 0) {
                    hocPhiTuDongSpan.textContent = "0 VNĐ (Tùy chỉnh)";
                    hocPhiTuyChinhInput.classList.remove('hidden');
                    lyDoThuKhacWrapper.classList.remove('hidden'); // (MỚI)
                } else {
                    hocPhiTuDongSpan.textContent = `${new Intl.NumberFormat('vi-VN').format(hocPhi)} VNĐ`;
                    hocPhiTuyChinhInput.classList.add('hidden');
                    hocPhiTuyChinhInput.value = ""; // Xóa giá trị cũ
                    lyDoThuKhacWrapper.classList.add('hidden'); // (MỚI)
                    document.getElementById('lyDoThuKhac').value = ""; // (MỚI)
                }
                
                updateAutoAssignment();
            }

            // (MỚI) Hàm cho Admin form
            function updateAdminHocPhi() {
                const adminGoiHocSelect = document.getElementById('adminGoiHoc');
                const adminHocPhiTuyChinhInput = document.getElementById('adminHocPhiTuyChinh');
                const adminLyDoThuKhacWrapper = document.getElementById('adminLyDoThuKhacWrapper'); // (MỚI)
                const selectedGoiOption = adminGoiHocSelect.options[adminGoiHocSelect.selectedIndex];
                let hocPhi = 0;
                if (selectedGoiOption && selectedGoiOption.dataset.hocphi) {
                    hocPhi = Number(selectedGoiOption.dataset.hocphi);
                }
                
                if (hocPhi === 0) {
                    adminHocPhiTuyChinhInput.classList.remove('hidden');
                    adminLyDoThuKhacWrapper.classList.remove('hidden'); // (MỚI)
                } else {
                    adminHocPhiTuyChinhInput.classList.add('hidden');
                    adminHocPhiTuyChinhInput.value = ""; 
                    adminLyDoThuKhacWrapper.classList.add('hidden'); // (MỚI)
                    document.getElementById('adminLyDoThuKhac').value = ""; // (MỚI)
                }
            }

            async function getNextHlv(caHoc) {
                if (!caHoc) return "Vui lòng chọn Ca Học";
                if (HLV_SETTINGS_LIST.length === 0) return "Lỗi: Chưa có HLV";

                try {
                    const hlvInCa = HLV_SETTINGS_LIST.filter(hlv => hlv.ca === caHoc);
                    if (hlvInCa.length === 0) return "Không có HLV cho ca này";

                    const q = query(dbHocVienCollection, where("loaiHD", "==", "Thường"), where("caHoc", "==", caHoc));
                    const querySnapshot = await getDocs(q);
                    const thuongRegistrations = querySnapshot.docs.map(doc => doc.data());

                    let hlvCounts = hlvInCa.map(hlv => ({ ...hlv, count: 0 }));

                    thuongRegistrations.forEach(reg => {
                        const hlvIndex = hlvCounts.findIndex(hlv => hlv.ten === reg.hlvPhuTrach);
                        if (hlvIndex > -1) hlvCounts[hlvIndex].count++;
                    });

                    const minCount = Math.min(...hlvCounts.map(hlv => hlv.count));
                    const candidates = hlvCounts.filter(hlv => hlv.count === minCount);
                    candidates.sort((a, b) => a.uuTien - b.uuTien);

                    return candidates[0].ten;

                } catch (error) {
                    console.error("Lỗi khi lấy HLV tiếp theo:", error);
                    showMessage("Lỗi khi tính toán HLV. Vui lòng thử lại.", "error");
                    return "Lỗi... Thử lại";
                }
            }

            async function updateAutoAssignment() {
                const selectedCa = document.getElementById('caHoc').value;
                const hlvDuocGanSpan = document.getElementById('hlvDuocGan');
                hlvDuocGanSpan.textContent = "Đang tính toán...";
                const nextHlv = await getNextHlv(selectedCa);
                hlvDuocGanSpan.textContent = nextHlv;
            }

            async function handleGhiDanhAndPrint() {
                if (!currentUserId) {
                    showMessage("Lỗi xác thực. Vui lòng tải lại trang.", "error");
                    return;
                }

                // Lấy dữ liệu
                const tenHV = document.getElementById('tenHV').value;
                const dienThoai = document.getElementById('dienThoai').value;
                const maTheHV = document.getElementById('maTheHV').value;
                const soPhieuThu = document.getElementById('soPhieuThu').value; // (MỚI)
                const selectedGoiOption = document.getElementById('goiHoc').options[document.getElementById('goiHoc').selectedIndex];
                const goiHoc = selectedGoiOption.value;
                let hocPhi = Number(selectedGoiOption.dataset.hocphi);
                let lyDoThuKhac = ""; // (MỚI)
                
                // (MỚI) Kiểm tra học phí tùy chỉnh
                if (hocPhi === 0) {
                    hocPhi = Number(document.getElementById('hocPhiTuyChinh').value);
                    if (hocPhi <= 0) {
                        showMessage("Vui lòng nhập học phí cho Gói Khác.", "warning");
                        return;
                    }
                    lyDoThuKhac = document.getElementById('lyDoThuKhac').value; // (MỚI)
                }

                const caHoc = document.getElementById('caHoc').value;
                const hlvDuocGan = document.getElementById('hlvDuocGan').textContent;
                const thanhToan = document.getElementById('thanhToan').value; 

                if (!tenHV || !goiHoc || !caHoc || !thanhToan || hlvDuocGan.includes("Vui lòng") || hlvDuocGan.includes("Lỗi")) {
                    showMessage("Vui lòng nhập đầy đủ thông tin (Tên, Gói, Ca, Thanh toán).", "warning");
                    return;
                }

                const ghiDanhButton = document.getElementById('ghiDanhButton');
                ghiDanhButton.disabled = true;
                document.getElementById('ghiDanhText').classList.add('hidden');
                document.getElementById('ghiDanhLoading').classList.remove('hidden');

                const newRegistration = {
                    timestamp: Timestamp.now(),
                    tenHV: tenHV,
                    dienThoai: dienThoai,
                    maTheHV: maTheHV,
                    soPhieuThu: soPhieuThu, // (MỚI)
                    goiHoc: goiHoc,
                    caHoc: caHoc,
                    hlvPhuTrach: hlvDuocGan,
                    loaiHD: "Thường",
                    ghiChu: "",
                    hocPhi: hocPhi,
                    thanhToan: thanhToan, 
                    lyDoThuKhac: lyDoThuKhac, // (SỬA)
                    addedByUserId: currentUserId
                };

                try {
                    const docRef = await addDoc(dbHocVienCollection, newRegistration);
                    showMessage("Ghi danh thành công! Đang chuẩn bị phiếu...", "success");
                    
                    printRegistrationSlip({ ...newRegistration, id: docRef.id });

                    // Xóa form
                    document.getElementById('tenHV').value = "";
                    document.getElementById('dienThoai').value = "";
                    document.getElementById('maTheHV').value = "";
                    document.getElementById('soPhieuThu').value = ""; // (MỚI)
                    document.getElementById('goiHoc').selectedIndex = 0;
                    document.getElementById('caHoc').selectedIndex = 0;
                    document.getElementById('thanhToan').selectedIndex = 0;
                    document.getElementById('hocPhiTuyChinh').value = "";
                    document.getElementById('hocPhiTuyChinh').classList.add('hidden');
                    document.getElementById('lyDoThuKhacWrapper').classList.add('hidden'); // (MỚI)
                    document.getElementById('lyDoThuKhac').value = ""; // (MỚI)
                    document.getElementById('hlvDuocGan').textContent = "Vui lòng chọn Ca Học";
                    document.getElementById('hocPhiTuDong').textContent = "0 VNĐ";
                } catch (error) {
                    console.error("Lỗi ghi danh:", error);
                    showMessage("Lỗi khi lưu dữ liệu. Vui lòng thử lại.", "error");
                } finally {
                    ghiDanhButton.disabled = false;
                    document.getElementById('ghiDanhText').classList.remove('hidden');
                    document.getElementById('ghiDanhLoading').classList.add('hidden');
                }
            }
            
            /* ===== 7. LOGIC ADMIN (GHI ĐÈ & BÁO CÁO) ===== */

            async function handleAdminAdd() {
                if (!currentUserId) {
                    showMessage("Lỗi xác thực. Vui lòng tải lại trang.", "error");
                    return;
                }
                
                const tenHV = document.getElementById('adminTenHV').value;
                const dienThoai = document.getElementById('adminDienThoai').value;
                const maTheHV = document.getElementById('adminMaTheHV').value;
                const soPhieuThu = document.getElementById('adminSoPhieuThu').value; // (MỚI)
                const adminGoiHocSelect = document.getElementById('adminGoiHoc');
                const selectedGoiOption = adminGoiHocSelect.options[adminGoiHocSelect.selectedIndex];
                const goiHoc = selectedGoiOption.value;
                let hocPhi = Number(selectedGoiOption.dataset.hocphi);
                let lyDoThuKhac = ""; // (MỚI)

                // (MỚI) Kiểm tra học phí tùy chỉnh (Admin)
                if (hocPhi === 0) {
                    hocPhi = Number(document.getElementById('adminHocPhiTuyChinh').value);
                    if (hocPhi <= 0) {
                        showMessage("Vui lòng nhập học phí cho Gói Khác.", "warning");
                        return;
                    }
                    lyDoThuKhac = document.getElementById('adminLyDoThuKhac').value; // (MỚI)
                }

                const caHoc = document.getElementById('adminCaHoc').value;
                const hlvPhuTrach = document.getElementById('adminHlvChon').value;
                const loaiHD = document.getElementById('adminLoaiHD').value;
                const ghiChu = document.getElementById('adminGhiChu').value;
                const thanhToan = document.getElementById('adminThanhToan').value; 

                if (!tenHV || !goiHoc || !caHoc || !hlvPhuTrach || !thanhToan) {
                    showMessage("Vui lòng nhập đầy đủ thông tin (Tên, Gói, Ca, HLV, Thanh toán).", "warning");
                    return;
                }
                
                const newRegistration = {
                    timestamp: Timestamp.now(),
                    tenHV: tenHV,
                    dienThoai: dienThoai,
                    maTheHV: maTheHV,
                    soPhieuThu: soPhieuThu, // (MỚI)
                    goiHoc: goiHoc,
                    caHoc: caHoc,
                    hlvPhuTrach: hlvPhuTrach,
                    loaiHD: loaiHD,
                    ghiChu: ghiChu,
                    hocPhi: hocPhi,
                    thanhToan: thanhToan, 
                    lyDoThuKhac: lyDoThuKhac, // (SỬA)
                    addedByUserId: currentUserId
                };
                
                try {
                    await addDoc(dbHocVienCollection, newRegistration);
                    showMessage("Admin đã thêm HĐ thành công!", "success");
                    // Xóa form
                    document.getElementById('adminTenHV').value = "";
                    document.getElementById('adminDienThoai').value = "";
                    document.getElementById('adminMaTheHV').value = "";
                    document.getElementById('adminSoPhieuThu').value = ""; // (MỚI)
                    adminGoiHocSelect.selectedIndex = 0;
                    document.getElementById('adminCaHoc').selectedIndex = 0;
                    document.getElementById('adminHlvChon').selectedIndex = 0;
                    document.getElementById('adminGhiChu').value = "";
                    document.getElementById('adminHocPhiTuyChinh').value = "";
                    document.getElementById('adminHocPhiTuyChinh').classList.add('hidden');
                    document.getElementById('adminLyDoThuKhacWrapper').classList.add('hidden'); // (MỚI)
                    document.getElementById('adminLyDoThuKhac').value = ""; // (MỚI)
                } catch (error) {
                    console.error("Lỗi admin thêm HĐ:", error);
                    showMessage("Lỗi khi lưu dữ liệu. Vui lòng thử lại.", "error");
                }
            }

            function toggleReportFilter() {
                const filterType = document.getElementById('reportFilterType').value;
                document.getElementById('filterMonthControls').classList.toggle('hidden', filterType !== 'month');
                document.getElementById('filterDateControls').classList.toggle('hidden', filterType !== 'date');
                document.getElementById('filterRangeControls').classList.toggle('hidden', filterType !== 'range');
            }

            async function handleViewReport() {
                const reportFilterType = document.getElementById('reportFilterType').value;
                let startOfPeriod, endOfPeriod;
                let reportTitle = "";

                try {
                    if (reportFilterType === 'month') {
                        const month = parseInt(document.getElementById('reportMonth').value);
                        const year = parseInt(document.getElementById('reportYear').value);
                        if (!month || !year) throw new Error("Tháng hoặc Năm không hợp lệ.");
                        startOfPeriod = Timestamp.fromDate(new Date(year, month - 1, 1, 0, 0, 0));
                        endOfPeriod = Timestamp.fromDate(new Date(new Date(year, month, 1).getTime() - 1));
                        reportTitle = `Tháng ${month}/${year}`;
                    } else if (reportFilterType === 'today') {
                        const now = new Date();
                        startOfPeriod = Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0));
                        endOfPeriod = Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999));
                        reportTitle = `Hôm Nay (${now.toLocaleDateString('vi-VN')})`;
                    } else if (reportFilterType === 'date') {
                        const reportDate = document.getElementById('reportDate').value;
                        if (!reportDate) throw new Error("Vui lòng chọn ngày.");
                        const date = new Date(reportDate);
                        startOfPeriod = Timestamp.fromDate(new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0));
                        endOfPeriod = Timestamp.fromDate(new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59, 999));
                        reportTitle = `Ngày ${date.toLocaleDateString('vi-VN')}`;
                    } else if (reportFilterType === 'range') {
                        const reportDateStart = document.getElementById('reportDateStart').value;
                        const reportDateEnd = document.getElementById('reportDateEnd').value;
                        if (!reportDateStart || !reportDateEnd) throw new Error("Vui lòng chọn ngày bắt đầu và kết thúc.");
                        const start = new Date(reportDateStart);
                        const end = new Date(reportDateEnd);
                        startOfPeriod = Timestamp.fromDate(new Date(start.getFullYear(), start.getMonth(), start.getDate(), 0, 0, 0));
                        endOfPeriod = Timestamp.fromDate(new Date(end.getFullYear(), end.getMonth(), end.getDate(), 23, 59, 59, 999));
                        reportTitle = `Từ ${start.toLocaleDateString('vi-VN')} đến ${end.toLocaleDateString('vi-VN')}`;
                    }

                    const q = query(dbHocVienCollection, 
                        where("timestamp", ">=", startOfPeriod), 
                        where("timestamp", "<=", endOfPeriod)
                    );
                    
                    const querySnapshot = await getDocs(q);
                    const registrations = querySnapshot.docs.map(doc => doc.data());
                    const reportTableBody = document.getElementById('reportTableBody');
                    
                    if (registrations.length === 0) {
                        reportTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Không tìm thấy dữ liệu cho: ${reportTitle}.</td></tr>`;
                        document.getElementById('reportTableFooter').classList.add('hidden');
                        currentReportCache = []; 
                        return;
                    }
                    
                    let reportData = {};
                    HLV_SETTINGS_LIST.forEach(hlv => {
                        reportData[hlv.ten] = { ten: hlv.ten, count: 0, totalRevenue: 0 };
                    });
                    
                    registrations.forEach(reg => {
                        if (reportData[reg.hlvPhuTrach]) {
                            reportData[reg.hlvPhuTrach].count++;
                            reportData[reg.hlvPhuTrach].totalRevenue += reg.hocPhi;
                        }
                    });

                    let reportArray = Object.values(reportData).sort((a, b) => b.totalRevenue - a.totalRevenue);
                    
                    currentReportCache = { title: reportTitle, data: reportArray }; 
                    renderReportTable(reportArray);

                } catch (error) {
                    console.error("Lỗi khi xem báo cáo:", error);
                    showMessage(error.message || "Lỗi khi tải dữ liệu báo cáo.", "error");
                }
            }
            
            function renderReportTable(reportArray) {
                const reportTableBody = document.getElementById('reportTableBody');
                const reportTableFooter = document.getElementById('reportTableFooter');
                reportTableBody.innerHTML = "";
                const formatter = new Intl.NumberFormat('vi-VN');

                let total_HV = 0, total_Revenue = 0, total_HBA = 0, total_HLV_Gross = 0, total_Tax = 0, total_HLV_Net = 0;

                // (MỚI) Lấy tỉ lệ từ settings
                const hbaRate = (REVENUE_SPLIT_SETTINGS.hba || 60) / 100;
                const hlvRate = 1 - hbaRate; // Tỉ lệ HLV = 100% - Tỉ lệ HBA
                const taxRate = (REVENUE_SPLIT_SETTINGS.tax || 10) / 100;

                // (MỚI) Cập nhật tiêu đề bảng
                document.getElementById('hbaPercentHeader').textContent = `HBA Nhận (${(hbaRate * 100).toFixed(0)}%)`;
                document.getElementById('hlvPercentHeader').textContent = `Tổng Hoa Hồng HLV (${(hlvRate * 100).toFixed(0)}%)`;
                document.getElementById('taxPercentHeader').textContent = `Thuế TNCN (${(taxRate * 100).toFixed(0)}%)`;

                reportArray.forEach(hlv => {
                    if (hlv.count === 0) return; 

                    const revenue = hlv.totalRevenue;
                    
                    // (SỬA) Dùng tỉ lệ động
                    const hbaShare = revenue * hbaRate;
                    const hlvGross = revenue * hlvRate;
                    const tax = hlvGross * taxRate;
                    const hlvNet = hlvGross - tax;

                    total_HV += hlv.count;
                    total_Revenue += revenue;
                    total_HBA += hbaShare;
                    total_HLV_Gross += hlvGross;
                    total_Tax += tax;
                    total_HLV_Net += hlvNet;

                    reportTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${hlv.ten}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${hlv.count}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${formatter.format(revenue)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatter.format(hbaShare)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatter.format(hlvGross)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-500">(${formatter.format(tax)})</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${formatter.format(hlvNet)}</td>
                        </tr>
                    `;
                });

                reportTableFooter.innerHTML = `
                    <td class="px-6 py-3 text-left">TỔNG CỘNG</td>
                    <td class="px-6 py-3 text-left">${total_HV}</td>
                    <td class="px-6 py-3 text-left">${formatter.format(total_Revenue)}</td>
                    <td class="px-6 py-3 text-left">${formatter.format(total_HBA)}</td>
                    <td class="px-6 py-3 text-left">${formatter.format(total_HLV_Gross)}</td>
                    <td class="px-6 py-3 text-left text-red-600">(${formatter.format(total_Tax)})</td>
                    <td class="px-6 py-3 text-left text-green-700">${formatter.format(total_HLV_Net)}</td>
                `;
                reportTableFooter.classList.remove('hidden');
            }
            
            /* ===== 8. LẮNG NGHE REALTIME & RENDER BẢNG ===== */
            
            function startRealtimeListener() {
                if (!dbHocVienCollection) return;
                
                if (unsubscribeHocVien) {
                    unsubscribeHocVien();
                    console.log("Đã tắt listener cũ.");
                }

                console.log("Bắt đầu listener real-time mới...");
                const q = query(dbHocVienCollection); 

                unsubscribeHocVien = onSnapshot(q, (querySnapshot) => {
                    let allDocs = [];
                    querySnapshot.forEach((doc) => {
                        allDocs.push({ id: doc.id, ...doc.data() }); 
                    });

                    allDocs.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                    allStudentsCache = allDocs; 

                    updateDashboardStats(allDocs);
                    renderHistoryTable(allDocs);
                    
                    if (document.getElementById('leTanView').offsetParent !== null) { 
                        updateAutoAssignment();
                    }

                }, (error) => {
                    console.error("Lỗi khi lắng nghe real-time:", error);
                    if (auth.currentUser) {
                        showMessage("Mất kết nối real-time.", "error");
                    }
                });
            }
            
            function renderHistoryTable(data) {
                const historyTableBody = document.getElementById('historyTableBody');
                historyTableBody.innerHTML = "";
                const formatter = new Intl.NumberFormat('vi-VN');

                if (data.length === 0) {
                    historyTableBody.innerHTML = `<tr><td colspan="13" class="px-6 py-4 text-center text-gray-500">Chưa có dữ liệu.</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    const timestamp = item.timestamp.toDate().toLocaleString('vi-VN', { 
                        day: '2-digit', month: '2-digit', year: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                    const loaiHDClass = item.loaiHD === 'Chỉ Định' ? 'text-red-600 font-bold' : 'text-gray-500';

                    historyTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${timestamp}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.soPhieuThu || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.maTheHV || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.tenHV}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.dienThoai || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.hlvPhuTrach}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.goiHoc}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatter.format(item.hocPhi)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${loaiHDClass}">${item.loaiHD}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.thanhToan || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.lyDoThuKhac || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ghiChu || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium admin-only">
                                <button class="text-blue-600 hover:text-blue-900 edit-btn" data-id="${item.id}">Sửa</button>
                                <button class="text-red-600 hover:text-red-900 ml-4 delete-btn" data-id="${item.id}" data-name="${item.tenHV}">Xóa</button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            /* ===== 9. HÀM TIỆN ÍCH (MESSAGE BOX, STATS, IN ẤN) ===== */
            
            function showMessage(text, type = 'success') {
                messageText.textContent = text;
                messageBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-400', 'text-white', 'text-gray-800', 'hide');

                if (type === 'success') messageBox.classList.add('bg-green-500', 'text-white');
                else if (type === 'error') messageBox.classList.add('bg-red-500', 'text-white');
                else if (type === 'warning') messageBox.classList.add('bg-yellow-400', 'text-gray-800');

                messageBox.classList.remove('hidden');

                clearTimeout(messageTimer);
                messageTimer = setTimeout(() => {
                    messageBox.classList.add('hide');
                }, 3000);
            }

            function updateDashboardStats(allDocs) {
                const now = new Date();
                const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                const endToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                const firstDayOfWeek = new Date(now);
                firstDayOfWeek.setDate(now.getDate() - now.getDay());
                firstDayOfWeek.setHours(0, 0, 0, 0);
                const startMonth = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
                
                let todayCount = 0, weekCount = 0, monthCount = 0, todayRevenue = 0;
                let todayDocs = [];

                for (const doc of allDocs) {
                    const docTime = doc.timestamp.toDate();
                    if (docTime >= startToday && docTime <= endToday) {
                        todayCount++;
                        todayRevenue += doc.hocPhi; // (SỬA) Thêm tính doanh thu
                        todayDocs.push(doc); 
                    }
                    if (docTime >= firstDayOfWeek) weekCount++;
                    if (docTime >= startMonth) monthCount++;
                }
                
                document.getElementById('statTodayCount').textContent = todayCount;
                document.getElementById('statWeekCount').textContent = weekCount;
                document.getElementById('statMonthCount').textContent = monthCount;
                document.getElementById('todayRevenueHeader').textContent = `${new Intl.NumberFormat('vi-VN').format(todayRevenue)} VNĐ`; // (SỬA) Hiển thị doanh thu

                renderDailyReportTable(todayDocs);
                dailyReportCache = todayDocs; 
            }
            
            function renderDailyReportTable(todayDocs) {
                const dailyReportTableBody = document.getElementById('dailyReportTableBody');
                dailyReportTableBody.innerHTML = "";
                const formatter = new Intl.NumberFormat('vi-VN');
                if (todayDocs.length === 0) {
                    dailyReportTableBody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-center text-gray-500">Chưa có HV mới hôm nay.</td></tr>`;
                    return;
                }
                todayDocs.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                
                todayDocs.forEach(item => { 
                    dailyReportTableBody.innerHTML += `
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.tenHV}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${formatter.format(item.hocPhi)}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${item.hlvPhuTrach}</td>
                        </tr>
                    `;
                });
            }


            // ----- Chức năng In Phiếu Ghi Danh -----
            function printRegistrationSlip(regData) {
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                const formatter = new Intl.NumberFormat('vi-VN');
                const now = new Date().toLocaleString('vi-VN');
                
                const tenHVRutGon = regData.tenHV.split(' ').pop();
                const qrText = `https://api.vietqr.io/image/${PAYMENT_SETTINGS.bankBin}-${PAYMENT_SETTINGS.accountNumber}-compact.png?amount=${regData.hocPhi}&addInfo=HBA Q6 ${tenHVRutGon}`;
                
                const content = `
                    <html>
                    <head>
                        <title>Phiếu Ghi Danh ${regData.tenHV}</title>
                        <style>
                            ${Array.from(document.styleSheets)
                                .filter(sheet => sheet.href === null)
                                .map(sheet => Array.from(sheet.cssRules)
                                    .map(rule => rule.cssText)
                                    .join('\n'))
                                .join('\n')}
                            
                            body { background-color: #fff; font-family: 'Arial', sans-serif; }
                            .print-container { display: block; }
                            .no-print { display: none !important; }
                             @media print {
                                body { margin: 0; padding: 0; }
                                .print-container { padding: 20px; max-width: 800px; margin: 0 auto; }
                                .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                .print-table th, .print-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                                .print-table th { background-color: #f4f4f4; }
                                .print-header { text-align: center; margin-bottom: 30px; }
                                .print-header h1 { margin: 0; font-size: 24px; }
                                .print-header p { margin: 5px 0; font-size: 14px; }
                                .print-qr { text-align: center; margin-top: 20px; }
                                .print-qr img { width: 200px; height: 200px; }
                                .print-footer { margin-top: 50px; display: flex; justify-content: space-between; font-size: 14px; }
                            }
                        </style>
                    </head>
                    <body class="print-container">
                        <div class="print-header">
                            <h1>HỒ BƠI HBA QUẬN 6</h1>
                            <p>Phiếu Ghi Danh & Thu Phí</p>
                            <p>Ngày giờ: ${now}</p>
                            ${regData.lyDoThuKhac ? `<p style="font-style: italic;">Lý do thu: ${regData.lyDoThuKhac}</p>` : ''}
                        </div>

                        <table class="print-table">
                            <tr><td style="width: 200px;">Học viên:</td><td><strong>${regData.tenHV}</strong></td></tr>
                            <tr><td>Số Phiếu Thu:</td><td>${regData.soPhieuThu || ''}</td></tr>
                            <tr><td>Mã Thẻ HV:</td><td>${regData.maTheHV || ''}</td></tr>
                            <tr><td>Điện thoại:</td><td>${regData.dienThoai || ''}</td></tr>
                            <tr><td>Gói học:</td><td>${regData.goiHoc}</td></tr>
                            <tr><td>Học phí:</td><td><strong>${formatter.format(regData.hocPhi)} VNĐ</strong></td></tr>
                            <tr><td>HLV Phụ trách:</td><td>${regData.hlvPhuTrach}</td></tr>
                            <tr><td>Hình thức:</td><td>${regData.thanhToan}</td></tr>
                        </table>

                        ${regData.thanhToan === 'Chuyển khoản' ? `
                        <div class="print-qr">
                            <p>Quét mã QR để thanh toán (App Ngân hàng)</p>
                            <img src="${qrText}" alt="QR Code Thanh toán" />
                            <p style="font-size: 14px; margin-top: 10px;">
                                Ngân hàng: <strong>${PAYMENT_SETTINGS.bankName}</strong><br>
                                STK: <strong>${PAYMENT_SETTINGS.accountNumber}</strong><br>
                                Chủ TK: <strong>${PAYMENT_SETTINGS.accountName}</strong><br>
                                Nội dung: HBA Q6 ${tenHVRutGon}
                            </p>
                        </div>
                        ` : '<p style="margin-top: 20px;">Vui lòng thu tiền mặt.</p>'}

                        <div class="print-footer">
                            <span>Người lập phiếu</span>
                            <span>Học viên / Phụ huynh</span>
                        </div>
                    </body>
                    </html>
                `;
                
                printWindow.document.write(content);
                printWindow.document.close(); 
                printWindow.focus(); 
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500); 
            }

            // ----- Chức năng Sửa/Xóa Học viên -----
            async function handleShowEditModal(docId) {
                try {
                    const docRef = doc(dbHocVienCollection, docId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('editStudentId').value = docId;
                        document.getElementById('editTenHV').value = data.tenHV;
                        document.getElementById('editDienThoai').value = data.dienThoai || '';
                        document.getElementById('editMaTheHV').value = data.maTheHV || '';
                        document.getElementById('editSoPhieuThu').value = data.soPhieuThu || ''; // (MỚI)
                        document.getElementById('editGoiHoc').value = data.goiHoc;
                        document.getElementById('editCaHoc').value = data.caHoc;
                        document.getElementById('editHlvChon').value = data.hlvPhuTrach;
                        document.getElementById('editLoaiHD').value = data.loaiHD;
                        document.getElementById('editThanhToan').value = data.thanhToan || 'Tiền mặt';
                        document.getElementById('editGhiChu').value = data.ghiChu || '';

                        const editGoiHocSelect = document.getElementById('editGoiHoc');
                        const editHocPhiTuyChinhInput = document.getElementById('editHocPhiTuyChinh');
                        const selectedGoiOption = editGoiHocSelect.options[editGoiHocSelect.selectedIndex];
                        let hocPhiChuan = Number(selectedGoiOption.dataset.hocphi);

                        const editLyDoThuKhacWrapper = document.getElementById('editLyDoThuKhacWrapper');
                        const editLyDoThuKhacInput = document.getElementById('editLyDoThuKhac');

                        if (hocPhiChuan === 0 || data.hocPhi !== hocPhiChuan) {
                            editHocPhiTuyChinhInput.classList.remove('hidden');
                            editHocPhiTuyChinhInput.value = data.hocPhi;
                            editLyDoThuKhacWrapper.classList.remove('hidden'); 
                            editLyDoThuKhacInput.value = data.lyDoThuKhac || ''; 
                        } else {
                            editHocPhiTuyChinhInput.classList.add('hidden');
                            editHocPhiTuyChinhInput.value = "";
                            editLyDoThuKhacWrapper.classList.add('hidden'); 
                            editLyDoThuKhacInput.value = ""; 
                        }
                        
                        document.getElementById('editStudentModal').classList.remove('hidden');
                    } else {
                        showMessage("Không tìm thấy học viên.", "error");
                    }
                } catch (error) {
                    console.error("Lỗi khi lấy thông tin sửa:", error);
                    showMessage("Lỗi tải dữ liệu để sửa.", "error");
                }
            }

            async function handleUpdateStudent() {
                const docId = document.getElementById('editStudentId').value;
                if (!docId) return;

                const editGoiHocSelect = document.getElementById('editGoiHoc');
                const selectedGoiOption = editGoiHocSelect.options[editGoiHocSelect.selectedIndex];
                let hocPhi = Number(selectedGoiOption.dataset.hocphi);
                let lyDoThuKhac = ""; // (MỚI)

                if (hocPhi === 0) {
                    hocPhi = Number(document.getElementById('editHocPhiTuyChinh').value);
                    if (hocPhi <= 0) {
                        showMessage("Vui lòng nhập học phí.", "warning");
                        return;
                    }
                    lyDoThuKhac = document.getElementById('editLyDoThuKhac').value; // (MỚI)
                } else {
                    const hocPhiTuyChinhInput = document.getElementById('editHocPhiTuyChinh');
                    if (!hocPhiTuyChinhInput.classList.contains('hidden') && hocPhiTuyChinhInput.value) {
                         hocPhi = Number(hocPhiTuyChinhInput.value);
                         lyDoThuKhac = document.getElementById('editLyDoThuKhac').value; // (MỚI)
                    }
                }

                const updatedData = {
                    tenHV: document.getElementById('editTenHV').value,
                    dienThoai: document.getElementById('editDienThoai').value,
                    maTheHV: document.getElementById('editMaTheHV').value,
                    soPhieuThu: document.getElementById('editSoPhieuThu').value, // (MỚI)
                    goiHoc: document.getElementById('editGoiHoc').value,
                    caHoc: document.getElementById('editCaHoc').value,
                    hlvPhuTrach: document.getElementById('editHlvChon').value,
                    loaiHD: document.getElementById('editLoaiHD').value,
                    thanhToan: document.getElementById('editThanhToan').value,
                    lyDoThuKhac: lyDoThuKhac, // (MỚI)
                    ghiChu: document.getElementById('editGhiChu').value,
                    hocPhi: hocPhi
                };

                try {
                    const docRef = doc(dbHocVienCollection, docId);
                    await updateDoc(docRef, updatedData);
                    showMessage("Cập nhật học viên thành công!", "success");
                    document.getElementById('editStudentModal').classList.add('hidden');
                } catch (error) {
                    console.error("Lỗi khi cập nhật:", error);
                    showMessage("Lỗi lưu thay đổi.", "error");
                }
            }

            async function handleDeleteStudent(docId, tenHV) {
                try {
                    await deleteDoc(doc(dbHocVienCollection, docId));
                    showMessage(`Đã xóa học viên ${tenHV}.`, "success");
                } catch (error) {
                    console.error("Lỗi khi xóa:", error);
                    showMessage("Lỗi khi xóa học viên.", "error");
                }
            }

            // ----- Chức năng In/Export Báo Cáo -----
            function handlePrintReport() {
                if (!currentReportCache.data || currentReportCache.data.length === 0) {
                    showMessage("Không có dữ liệu báo cáo để in.", "warning");
                    return;
                }
                
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                const title = currentReportCache.title || "Báo Cáo Doanh Thu";
                const reportHtml = document.getElementById('reportTableBody').innerHTML;
                const footerHtml = document.getElementById('reportTableFooter').innerHTML;
                const headerHtml = document.querySelector('#adminView table thead').innerHTML;

                const content = `
                    <html><head><title>Báo Cáo Doanh Thu HBA</title>
                    <style>
                        ${Array.from(document.styleSheets)
                            .filter(sheet => sheet.href === null)
                            .map(sheet => Array.from(sheet.cssRules)
                                .map(rule => rule.cssText)
                                .join('\n'))
                            .join('\n')}
                        
                        body { background-color: #fff; font-family: 'Arial', sans-serif; }
                        .print-container { display: block; }
                        .no-print { display: none !important; }
                        .print-table th, .print-table td { font-size: 12px; }
                         @media print {
                            body { margin: 0; padding: 0; }
                            .print-container { padding: 20px; max-width: 800px; margin: 0 auto; }
                            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            .print-table th, .print-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                            .print-table th { background-color: #f4f4f4; }
                            .print-header { text-align: center; margin-bottom: 30px; }
                            .print-header h1 { margin: 0; font-size: 24px; }
                            .print-header p { margin: 5px 0; font-size: 14px; }
                            .print-footer { margin-top: 50px; display: flex; justify-content: space-between; font-size: 14px; }
                        }
                    </style>
                    </head>
                    <body class="print-container">
                        <div class="print-header">
                            <h1>Báo Cáo Doanh Thu</h1>
                            <p>Thời gian: ${title}</p>
                        </div>
                        <table class="print-table">
                            <thead>${headerHtml}</thead>
                            <tbody>${reportHtml}</tbody>
                            <tfoot style="background-color: #f4f4f4; font-weight: bold;">${footerHtml}</tfoot>
                        </table>
                    </body></html>
                `;
                
                printWindow.document.write(content);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            }

            function handleExportExcel() {
                if (allStudentsCache.length === 0) {
                    showMessage("Không có dữ liệu để export.", "warning");
                    return;
                }

                const dataToExport = allStudentsCache.map(item => ({
                    'Thời gian': item.timestamp.toDate().toLocaleString('vi-VN'),
                    'Tên Học Viên': item.tenHV,
                    'Mã Thẻ HV': item.maTheHV,
                    'Số Phiếu Thu': item.soPhieuThu, // (MỚI)
                    'Điện thoại': item.dienThoai,
                    'HLV Phụ Trách': item.hlvPhuTrach,
                    'Gói Học': item.goiHoc,
                    'Học Phí': item.hocPhi,
                    'Loại HĐ': item.loaiHD,
                    'Thanh Toán': item.thanhToan,
                    'Lý Do Thu Khác': item.lyDoThuKhac, // (SỬA)
                    'Ghi Chú': item.ghiChu,
                    'Ca Học': item.caHoc
                }));

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "DanhSachHocVien");
                XLSX.writeFile(wb, `HBA_DanhSachHocVien_Full_${new Date().toISOString().split('T')[0]}.xlsx`);
                showMessage("Đang tải file Excel...", "success");
            }
            
            function handleExportDailyExcel() {
                if (dailyReportCache.length === 0) {
                    showMessage("Không có dữ liệu hôm nay để export.", "warning");
                    return;
                }

                const dataToExport = dailyReportCache.map(item => ({
                    'Thời gian': item.timestamp.toDate().toLocaleString('vi-VN'),
                    'Tên Học Viên': item.tenHV,
                    'Mã Thẻ HV': item.maTheHV,
                    'Số Phiếu Thu': item.soPhieuThu, // (MỚI)
                    'Điện thoại': item.dienThoai,
                    'HLV Phụ Trách': item.hlvPhuTrach,
                    'Gói Học': item.goiHoc,
                    'Học Phí': item.hocPhi,
                    'Loại HĐ': item.loaiHD,
                    'Thanh Toán': item.thanhToan,
                    'Lý Do Thu Khác': item.lyDoThuKhac, // (SỬA)
                }));

                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "BaoCaoHomNay");
                XLSX.writeFile(wb, `HBA_BaoCaoNgay_${new Date().toISOString().split('T')[0]}.xlsx`);
                showMessage("Đang tải file Excel (Hôm nay)...", "success");
            }
            
            async function handleImportExcel() {
                const excelImportFile = document.getElementById('excelImportFile');
                const file = excelImportFile.files[0];
                if (!file) {
                    showMessage("Vui lòng chọn một file Excel.", "warning");
                    return;
                }

                const importButton = document.getElementById('importExcelButton');
                const importText = document.getElementById('importExcelText');
                const importLoading = document.getElementById('importExcelLoading');

                importButton.disabled = true;
                importText.classList.add('hidden');
                importLoading.classList.remove('hidden');

                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (jsonData.length === 0) throw new Error("File Excel rỗng hoặc sai định dạng.");

                        let importedCount = 0;
                        for (const row of jsonData) {
                            if (!row.tenHV || !row.hlvPhuTrach || !row.hocPhi || !row.caHoc || !row.goiHoc || !row.loaiHD || !row.thanhToan) {
                                console.warn("Bỏ qua dòng (thiếu dữ liệu bắt buộc):", row);
                                continue;
                            }

                            const newRegistration = {
                                timestamp: Timestamp.now(),
                                tenHV: row.tenHV,
                                goiHoc: row.goiHoc,
                                caHoc: row.caHoc,
                                hlvPhuTrach: row.hlvPhuTrach,
                                loaiHD: row.loaiHD, 
                                ghiChu: row.ghiChu || "Imported",
                                hocPhi: Number(row.hocPhi),
                                thanhToan: row.thanhToan,
                                dienThoai: row.dienThoai || '',
                                maTheHV: row.maTheHV || '',
                                soPhieuThu: row.soPhieuThu || '', 
                                lyDoThuKhac: row.lyDoThuKhac || '', // (MỚI)
                                addedByUserId: currentUserId
                            };

                            await addDoc(dbHocVienCollection, newRegistration);
                            importedCount++;
                        }
                        showMessage(`Import thành công ${importedCount}/${jsonData.length} học viên.`, "success");
                    };
                    
                    reader.onerror = (e) => { throw new Error("Không thể đọc file."); };
                    reader.readAsArrayBuffer(file);
                    
                } catch (error) {
                    console.error("Lỗi khi import Excel:", error);
                    showMessage(error.message || "Lỗi khi import file.", "error");
                } finally {
                    importButton.disabled = false;
                    importText.classList.remove('hidden');
                    importLoading.classList.add('hidden');
                    excelImportFile.value = ""; 
                }
            }


            // ----- Chức năng Quản lý HLV & Settings -----
            function renderHlvSettingsTable() {
                const hlvSettingsTableBody = document.getElementById('hlvSettingsTableBody');
                hlvSettingsTableBody.innerHTML = "";
                HLV_SETTINGS_LIST.sort((a, b) => a.ca.localeCompare(b.ca) || a.uuTien - b.uuTien);
                
                HLV_SETTINGS_LIST.forEach(hlv => {
                    hlvSettingsTableBody.innerHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${hlv.ten}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${hlv.ca}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${hlv.uuTien}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-blue-600 hover:text-blue-900 edit-hlv-btn" data-id="${hlv.id}">Sửa</button>
                                <button class="text-red-600 hover:text-red-900 ml-4 delete-hlv-btn" data-id="${hlv.id}">Xóa</button>
                            </td>
                        </tr>
                    `;
                });
                updateHlvDropdowns();
            }
            
            function updateHlvDropdowns() {
                const adminHlvChonSelect = document.getElementById('adminHlvChon');
                const editHlvChonSelect = document.getElementById('editHlvChon');
                const hlvOptions = HLV_SETTINGS_LIST.map(hlv => `<option value="${hlv.ten}">${hlv.ten}</option>`).join('');
                adminHlvChonSelect.innerHTML = '<option value="">-- Chọn HLV --</option>' + hlvOptions;
                editHlvChonSelect.innerHTML = '<option value="">-- Chọn HLV --</option>' + hlvOptions;
            }

            function handleEditHlv(docId) {
                const hlv = HLV_SETTINGS_LIST.find(h => h.id === docId);
                if (hlv) {
                    document.getElementById('hlvEditId').value = hlv.id;
                    document.getElementById('hlvTen').value = hlv.ten;
                    document.getElementById('hlvCa').value = hlv.ca;
                    document.getElementById('hlvUuTien').value = hlv.uuTien;
                }
            }

            async function handleSaveHlv() {
                const ten = document.getElementById('hlvTen').value;
                const ca = document.getElementById('hlvCa').value;
                const uuTien = parseInt(document.getElementById('hlvUuTien').value);
                const editId = document.getElementById('hlvEditId').value;

                if (!ten || !ca || isNaN(uuTien)) {
                    showMessage("Vui lòng nhập đủ Tên, Ca, Ưu tiên cho HLV.", "warning");
                    return;
                }

                const hlvData = { ten, ca, uuTien };

                try {
                    if (editId) {
                        await updateDoc(doc(dbHlvCollection, editId), hlvData);
                        showMessage("Cập nhật HLV thành công!", "success");
                    } else {
                        await addDoc(dbHlvCollection, hlvData);
                        showMessage("Thêm HLV mới thành công!", "success");
                    }
                    
                    document.getElementById('hlvEditId').value = "";
                    document.getElementById('hlvTen').value = "";
                    document.getElementById('hlvUuTien').value = "";
                    
                    // Tải lại settings (để refresh bảng và dropdowns)
                    loadAppSettingsAndListeners(); // (SỬA) Gọi hàm tổng
                } catch (error) {
                    console.error("Lỗi lưu HLV:", error);
                    showMessage("Lỗi lưu HLV.", "error");
                }
            }

            async function handleDeleteHlv(docId) {
                try {
                    await deleteDoc(doc(dbHlvCollection, docId));
                    showMessage("Đã xóa HLV.", "success");
                    loadAppSettingsAndListeners(); // (SỬA) Gọi hàm tổng
                } catch (error) {
                    console.error("Lỗi xóa HLV:", error);
                    showMessage("Lỗi xóa HLV.", "error");
                }
            }

            // (MỚI) Hàm lưu Cài đặt Tỉ lệ
            async function handleSaveRevenueSplit() {
                const hbaPercent = parseInt(document.getElementById('splitHbaPercent').value);
                const taxPercent = parseInt(document.getElementById('splitTaxPercent').value);

                if (isNaN(hbaPercent) || hbaPercent < 0 || hbaPercent > 100) {
                    showMessage("Tỉ lệ HBA không hợp lệ (phải từ 0-100).", "warning");
                    return;
                }
                if (isNaN(taxPercent) || taxPercent < 0 || taxPercent > 100) {
                    showMessage("Tỉ lệ Thuế không hợp lệ (phải từ 0-100).", "warning");
                    return;
                }

                const splitData = {
                    hba: hbaPercent,
                    tax: taxPercent
                };

                try {
                    await setDoc(dbRevenueSplitDoc, splitData, { merge: true });
                    REVENUE_SPLIT_SETTINGS = splitData; // Cập nhật cache
                    showMessage("Lưu cài đặt tỉ lệ thành công!", "success");
                    // (MỚI) Tự động chạy lại báo cáo nếu đang xem
                    if (currentReportCache.data && currentReportCache.data.length > 0) {
                        renderReportTable(currentReportCache.data);
                    }
                } catch (error) {
                    console.error("Lỗi lưu tỉ lệ:", error);
                    showMessage("Lỗi lưu cài đặt tỉ lệ.", "error");
                }
            }

            async function handleSaveQr() {
                const qrData = {
                    bankName: document.getElementById('qrBankName').value,
                    bankBin: document.getElementById('qrBankBin').value,
                    accountNumber: document.getElementById('qrAccountNumber').value,
                    accountName: document.getElementById('qrAccountName').value
                };

                try {
                    await setDoc(dbPaymentSettingsDoc, qrData, { merge: true });
                    PAYMENT_SETTINGS = qrData; // Cập nhật cache
                    showMessage("Lưu cài đặt QR thành công!", "success");
                } catch (error) {
                    console.error("Lỗi lưu QR settings:", error);
                    showMessage("Lỗi lưu cài đặt QR.", "error");
                }
            }

        }); // (SỬA) Kết thúc DOMContentLoaded
    </script>
</body>
</html>




