<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HBA Booking App</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện SheetJS (Excel Export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Tải thư viện QRCode.js (Tạo QR) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* CSS cho message box tùy chỉnh (thay thế alert()) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .message-box {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .message-box.hide {
            animation: fadeOut 0.3s ease-in forwards;
        }
        
        /* CSS cho Modal (Sửa học viên) */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }

        /* (MỚI) CSS để ẩn/hiện các mục chỉ dành cho Admin */
        .admin-only {
            display: none; /* Ẩn các nút Sửa/Xóa mặc định */
        }
        /* (MỚI) Khi body có class 'admin-view', hiện các mục này */
        body.admin-view .admin-only {
            display: table-cell; /* Hiện trong bảng */
        }

        /* CSS cho bản in */
        @media print {
            body {
                margin: 0;
                padding: 0;
                font-family: 'Arial', sans-serif;
            }
            .no-print {
                display: none !important;
            }
            .print-container {
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
            }
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .print-table th, .print-table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }
            .print-table th {
                background-color: #f4f4f4;
            }
            .print-header {
                text-align: center;
                margin-bottom: 30px;
            }
            .print-header h1 {
                margin: 0;
                font-size: 24px;
            }
            .print-header p {
                margin: 5px 0;
                font-size: 14px;
            }
            .print-qr {
                text-align: center;
                margin-top: 20px;
            }
            .print-qr img {
                width: 150px;
                height: 150px;
            }
            .print-footer {
                margin-top: 50px;
                display: flex;
                justify-content: space-between;
                font-size: 14px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen no-print">

    <!-- Thanh Header -->
    <header class="bg-white shadow-md no-print">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-700">Hệ thống Quản lý Học viên BƠI HBA Q6</h1>
            <!-- (MỚI) Doanh thu hôm nay (Real-time) -->
            <div class="text-center">
                <span class="text-sm text-gray-500 uppercase">Doanh thu hôm nay</span>
                <p id="todayRevenueHeader" class="text-2xl font-bold text-green-600">0 VNĐ</p>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">UserID: <code id="userIdDisplay" class="font-mono">...</code></span>
                <!-- (MỚI) Thêm ID và class 'hidden' cho wrapper của nút gạt -->
                <div id="roleSwitcherWrapper" class="relative hidden">
                    <select id="roleSwitcher" class="appearance-none w-full bg-blue-600 text-white py-2 px-4 pr-8 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-400 cursor-pointer">
                        <option value="leTan">View: Lễ Tân</option>
                        <option value="admin">View: Quản Lý</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Nội dung chính -->
    <main class="container mx-auto p-6">

        <!-- ===== VIEW LỄ TÂN (INPUT_FORM) ===== -->
        <div id="leTanView">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Cột 1: Form Ghi Danh -->
                <div class="lg:col-span-2">
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Phiếu Ghi Danh Học Viên Mới</h2>
                        
                        <!-- Form nhập liệu -->
                        <!-- (SỬA) Bổ sung lại form bị thiếu -->
                        <div class="space-y-4 mb-6">
                            <div>
                                <label for="tenHV" class="block text-sm font-medium text-gray-700">Tên Học Viên</label>
                                <input type="text" id="tenHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="goiHoc" class="block text-sm font-medium text-gray-700">Gói Học</label>
                                    <select id="goiHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">-- Chọn gói học --</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="caHoc" class="block text-sm font-medium text-gray-700">Ca Học</label>
                                    <select id="caHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">-- Chọn ca học --</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <label class="block text-sm font-medium text-blue-700">HLV Được Gán (Tự động)</label>
                                    <span id="hlvDuocGan" class="mt-1 block text-lg font-bold text-blue-900">Vui lòng chọn Ca Học</span>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <label class="block text-sm font-medium text-green-700">Học Phí (Tự động)</label>
                                    <span id="hocPhiTuDong" class="mt-1 block text-lg font-bold text-green-900">0 VNĐ</span>
                                </div>
                            </div>
                            
                            <div>
                                <label for="thanhToan" class="block text-sm font-medium text-gray-700">Hình thức Thanh toán</label>
                                <select id="thanhToan" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- Chọn hình thức --</option>
                                    <option value="Tiền mặt">Tiền mặt</option>
                                    <option value="Chuyển khoản">Chuyển khoản</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="ghiDanhButton" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200">
                            <span id="ghiDanhText">Ghi Danh & In Phiếu</span>
                            <span id="ghiDanhLoading" class="hidden">Đang xử lý...</span>
                        </button>
                    </div>
                </div>

                <!-- Cột 2: Thống kê (Lễ Tân) -->
                <div class="space-y-6">
                    <!-- (MỚI) Thống Kê Nhanh -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Thống Kê Nhanh (Real-time)</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center bg-blue-50 p-3 rounded-lg">
                                <span class="text-sm font-medium text-blue-700">HV Mới Hôm Nay:</span>
                                <span id="statTodayCount" class="text-lg font-bold text-blue-800">0</span>
                            </div>
                            <div class="flex justify-between items-center bg-green-50 p-3 rounded-lg">
                                <span class="text-sm font-medium text-green-700">HV Mới Tuần Này:</span>
                                <span id="statWeekCount" class="text-lg font-bold text-green-800">0</span>
                            </div>
                            <div class="flex justify-between items-center bg-indigo-50 p-3 rounded-lg">
                                <span class="text-sm font-medium text-indigo-700">HV Mới Tháng Này:</span>
                                <span id="statMonthCount" class="text-lg font-bold text-indigo-800">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- (MỚI) Báo Cáo Trong Ngày (Lễ Tân) -->
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Ghi Danh Trong Ngày</h3>
                            <button id="exportDailyExcelButton" class="bg-emerald-500 text-white py-2 px-3 rounded-lg shadow-md text-sm font-semibold hover:bg-emerald-600">
                                Export Excel
                            </button>
                        </div>
                        <div class="overflow-y-auto max-h-[300px]">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên HV</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Học Phí</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HLV</th>
                                    </tr>
                                </thead>
                                <tbody id="dailyReportTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Dữ liệu real-time -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ===== VIEW QUẢN LÝ (ADMIN) ===== -->
        <div id="adminView" class="hidden space-y-8">
            
            <!-- 1. Form Thêm HĐ Chỉ Định -->
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto">
                <h2 class="text-2xl font-semibold text-red-700 mb-6">Thêm Hợp Đồng (Admin Override)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="adminTenHV" class="block text-sm font-medium text-gray-700">Tên Học Viên</label>
                        <input type="text" id="adminTenHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="adminGoiHoc" class="block text-sm font-medium text-gray-700">Gói Học</label>
                            <select id="adminGoiHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                        </div>
                        <div>
                            <label for="adminCaHoc" class="block text-sm font-medium text-gray-700">Ca Học</label>
                            <select id="adminCaHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="adminHlvChon" class="block text-sm font-medium text-gray-700">Chỉ định HLV</label>
                            <select id="adminHlvChon" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500"></select>
                        </div>
                        <div>
                            <label for="adminLoaiHD" class="block text-sm font-medium text-gray-700">Loại Hợp Đồng</label>
                            <select id="adminLoaiHD" class="mt-1 block w-full px-4 py-3 border border-red-500 bg-red-50 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="Chỉ Định">Chỉ Định</option>
                                <option value="Thường">Thường (Admin)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="adminThanhToan" class="block text-sm font-medium text-gray-700">Hình thức Thanh toán</label>
                        <select id="adminThanhToan" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                            <option value="Tiền mặt">Tiền mặt</option>
                            <option value="Chuyển khoản">Chuyển khoản</option>
                        </select>
                    </div>

                    <div>
                        <label for="adminGhiChu" class="block text-sm font-medium text-gray-700">Ghi Chú</label>
                        <input type="text" id="adminGhiChu" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="HĐ chỉ định Thầy Ngọc...">
                    </div>
                    
                    <button id="adminAddButton" class="w-full bg-red-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-200">
                        Thêm Hợp Đồng (Admin)
                    </button>
                </div>
            </div>

            <!-- 2. Báo Cáo Doanh Thu (REPORT) -->
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Báo Cáo Doanh Thu (Admin)</h2>
                
                <!-- (MỚI) Bộ lọc Nâng cao -->
                <div class="flex flex-wrap items-end space-x-4 mb-6">
                    <!-- Chọn loại lọc -->
                    <div>
                        <label for="reportFilterType" class="block text-sm font-medium text-gray-700">Loại Báo Cáo</label>
                        <select id="reportFilterType" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="month">Theo Tháng</option>
                            <option value="today">Hôm Nay</option>
                            <option value="date">Theo Ngày Cụ Thể</option>
                            <option value="range">Theo Khoảng Thời Gian</option>
                        </select>
                    </div>

                    <!-- Lọc theo tháng -->
                    <div id="filterMonthControls">
                        <div class="flex space-x-4">
                            <div>
                                <label for="reportMonth" class="block text-sm font-medium text-gray-700">Tháng</label>
                                <select id="reportMonth" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <!-- JS sẽ điền các tháng -->
                                </select>
                            </div>
                            <div>
                                <label for="reportYear" class="block text-sm font-medium text-gray-700">Năm</label>
                                <input type="number" id="reportYear" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" min="2020" max="2030">
                            </div>
                        </div>
                    </div>

                    <!-- Lọc theo ngày cụ thể -->
                    <div id="filterDateControls" class="hidden">
                        <div>
                            <label for="reportDate" class="block text-sm font-medium text-gray-700">Chọn Ngày</label>
                            <input type="date" id="reportDate" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <!-- Lọc theo khoảng thời gian -->
                    <div id="filterRangeControls" class="hidden">
                        <div class="flex space-x-4">
                            <div>
                                <label for="reportDateStart" class="block text-sm font-medium text-gray-700">Từ Ngày</label>
                                <input type="date" id="reportDateStart" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="reportDateEnd" class="block text-sm font-medium text-gray-700">Đến Ngày</label>
                                <input type="date" id="reportDateEnd" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Nút Xem Báo Cáo -->
                    <button id="viewReportButton" class="self-end bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                        Xem Báo Cáo
                    </button>

                    <!-- (MỚI) Menu Dropdown cho các nút In/Export -->
                    <div class="relative inline-block text-left self-end group">
                        <button class="bg-gray-700 text-white py-3 px-6 rounded-lg shadow-lg font-semibold hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            <span>Tác vụ khác...</span>
                            <svg class="inline w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10 hidden group-hover:block">
                            <div class="py-1" role="menu" aria-orientation="vertical">
                                <a href="#" id="printReportButton" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">In Báo Cáo (Đang xem)</a>
                                <a href="#" id="exportExcelButton" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Export Excel (Toàn bộ)</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bảng Báo Cáo -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HLV Phụ Trách</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng HV Mới</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng Doanh Thu (100%)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HBA Nhận (60%)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng Hoa Hồng HLV (40%)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thuế TNCN (10%)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HLV Thực Nhận</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu báo cáo sẽ được chèn vào đây -->
                            <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Chưa có dữ liệu. Vui lòng chọn tháng/năm và nhấn xem.</td></tr>
                        </tbody>
                        <tfoot class="bg-gray-100 font-bold">
                            <tr id="reportTableFooter" class="hidden">
                                <!-- Dữ liệu tổng cộng sẽ được chèn vào đây -->
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- 3. Lịch sử Ghi Danh (DATABASE) -->
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Lịch sử Ghi Danh (Real-time)</h2>
                <div class="overflow-x-auto max-h-[600px]">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thời gian</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên Học Viên</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HLV Phụ Trách</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gói Học</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Học Phí</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loại HĐ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thanh Toán</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ghi Chú</th>
                                <!-- (MỚI) Thêm class 'admin-only' và 'hidden' -->
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider admin-only">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu lịch sử sẽ được chèn vào đây -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 4. Quản lý HLV (SETTINGS) -->
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Quản lý HLV (Settings)</h2>
                
                <!-- Form thêm HLV -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 border rounded-lg">
                    <div>
                        <label for="hlvTen" class="block text-sm font-medium text-gray-700">Tên HLV</label>
                        <input type="text" id="hlvTen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Thầy Nguyễn Văn A">
                    </div>
                    <div>
                        <label for="hlvCa" class="block text-sm font-medium text-gray-700">Ca Dạy</label>
                        <select id="hlvCa" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option>Sáng</option>
                            <option>Chiều</option>
                        </select>
                    </div>
                    <div>
                        <label for="hlvUuTien" class="block text-sm font-medium text-gray-700">Thứ tự Ưu tiên</label>
                        <input type="number" id="hlvUuTien" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="1">
                    </div>
                    <button id="saveHlvButton" class_exists="self-end bg-green-600 text-white py-2 px-4 rounded-lg shadow font-semibold hover:bg-green-700">
                        Thêm/Cập nhật HLV
                    </button>
                    <input type="hidden" id="hlvEditId">
                </div>

                <!-- Bảng danh sách HLV -->
                <div class="overflow-x-auto max-h-[400px]">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên HLV</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ca Dạy</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ưu Tiên</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hlvSettingsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- HLV settings list -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- (MỚI) 6. Import Excel (Admin) -->
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto mt-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Import Dữ Liệu (Admin)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="excelImportFile" class="block text-sm font-medium text-gray-700">Chọn file Excel (.xlsx, .xls)</label>
                        <input type="file" id="excelImportFile" class="mt-1 block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100"
                            accept=".xlsx, .xls">
                    </div>
                    <p class="text-xs text-gray-600">
                        <strong>Lưu ý:</strong> Dữ liệu import sẽ bỏ qua luật chia lượt.
                        Các cột bắt buộc: <strong>tenHV, goiHoc, hocPhi, caHoc, hlvPhuTrach, loaiHD, thanhToan</strong>.
                        Cột <strong>ghiChu</strong> là tùy chọn.
                    </p>
                    <button id="importExcelButton" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-purple-700">
                        <span id="importExcelText">Bắt đầu Import</span>
                        <span id="importExcelLoading" class="hidden">Đang xử lý, vui lòng chờ...</span>
                    </button>
                </div>
            </div>

            <!-- 5. Cài đặt Thanh toán QR (SETTINGS) -->
            <div class="bg-white p-8 rounded-xl shadow-lg max-w-2xl mx-auto mt-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Cài đặt Thanh toán QR (Admin)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="qrBankName" class="block text-sm font-medium text-gray-700">Tên Ngân hàng (Vd: Vietinbank)</label>
                        <input type="text" id="qrBankName" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="qrBankBin" class="block text-sm font-medium text-gray-700">Bank BIN/Code (Vd: 970415 cho Vietinbank)</label>
                        <input type="text" id="qrBankBin" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="qrAccountNumber" class="block text-sm font-medium text-gray-700">Số Tài Khoản</label>
                        <input type="text" id="qrAccountNumber" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div>
                        <label for="qrAccountName" class="block text-sm font-medium text-gray-700">Tên Chủ Tài Khoản</Elabel>
                        <input type="text" id="qrAccountName" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <button id="saveQrButton" class="w-full bg-green-600 text-white py-3 px-6 rounded-lg shadow-lg font-semibold text-lg hover:bg-green-700">
                        Lưu Cài đặt QR
                    </button>
                </div>
            </div>

        </div> <!-- Kết thúc adminView -->

    </main>

    <!-- Modal Sửa Học Viên -->
    <div id="editStudentModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden" style="z-index: 100;">
        <div class="modal-content bg-white p-8 rounded-xl shadow-lg max-w-2xl w-full mx-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Chỉnh sửa Thông tin Học viên</h2>
            <input type="hidden" id="editStudentId">
            
            <div class="space-y-4">
                <div>
                    <label for="editTenHV" class="block text-sm font-medium text-gray-700">Tên Học Viên</label>
                    <input type="text" id="editTenHV" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editGoiHoc" class="block text-sm font-medium text-gray-700">Gói Học</label>
                        <select id="editGoiHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm"></select>
                    </div>
                    <div>
                        <label for="editCaHoc" class="block text-sm font-medium text-gray-700">Ca Học</label>
                        <select id="editCaHoc" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm"></select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="editHlvChon" class="block text-sm font-medium text-gray-700">HLV Phụ Trách</label>
                        <select id="editHlvChon" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm"></select>
                    </div>
                    <div>
                        <label for="editLoaiHD" class="block text-sm font-medium text-gray-700">Loại Hợp Đồng</label>
                        <select id="editLoaiHD" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                            <option value="Chỉ Định">Chỉ Định</option>
                            <option value="Thường">Thường</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="editThanhToan" class="block text-sm font-medium text-gray-700">Hình thức Thanh toán</label>
                    <select id="editThanhToan" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                        <option value="Tiền mặt">Tiền mặt</option>
                        <option value="Chuyển khoản">Chuyển khoản</option>
                    </select>
                </div>

                <div>
                    <label for="editGhiChu" class="block text-sm font-medium text-gray-700">Ghi Chú</label>
                    <input type="text" id="editGhiChu" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm">
                </div>
                
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="cancelEditButton" class="bg-gray-500 text-white py-2 px-6 rounded-lg shadow font-semibold hover:bg-gray-600">
                        Hủy
                    </button>
                    <button id="updateStudentButton" class="bg-blue-600 text-white py-2 px-6 rounded-lg shadow font-semibold hover:bg-blue-700">
                        Lưu Thay Đổi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box (Modal) -->
    <div id="messageBox" class="message-box hidden fixed top-10 right-10 max-w-sm p-4 rounded-lg shadow-lg" style="z-index: 200;">
        <p id="messageText"></p>
        <button id="closeMessage" class="absolute top-1 right-2 text-lg font-bold">&times;</button>
    </div>

    <!-- ===== SCRIPT LOGIC ===== -->
    <script type="module">
        /* ===== 1. FIREBASE IMPORTS ===== */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs,
            getDoc,
            doc,
            updateDoc,
            deleteDoc,
            setDoc,
            query, 
            where, 
            Timestamp, 
            onSnapshot,
            setLogLevel // Thêm setLogLevel
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // (MỚI) DANH SÁCH ADMIN (Dựa trên UserID anh cung cấp)
        const ADMIN_USER_ID_LIST = ["16603782104995605825"];

        /* ===== 2. CÀI ĐẶT CỐ ĐỊNH (từ file HuongDan_HeThong_HBA.md) ===== */
        
        // Bảng HLV (SETTINGS) - SẼ ĐƯỢC LOAD TỪ FIRESTORE
        // const HLV_SETTINGS = [ ... ]; // Xóa const này
        let HLV_SETTINGS_LIST = []; // Biến global để cache
        let PAYMENT_SETTINGS = {}; // Biến global để cache QR info

        // Danh sách Gói Học (SETTINGS)
        const GOI_HOC_SETTINGS = [
            { ten: "12 buổi (1.500.000)", hocPhi: 1500000 },
            { ten: "24 buổi (3.000.000)", hocPhi: 3000000 }
        ];

        // Danh sách Ca Học (SETTINGS)
        const CA_HOC_SETTINGS = ["Sáng", "Chiều"];

        /* ===== 3. KHỞI TẠO FIREBASE & AUTH ===== */
        
        // Biến toàn cục cho Firebase
        let app, auth, db, dbHocVienCollection, dbHlvCollection, dbPaymentSettingsDoc;
        let currentUserId = null;
        let isAdmin = false; // (MỚI) Biến toàn cục để check quyền Admin
        let allStudentsCache = []; // Cache cho Excel export
        let currentReportCache = []; // Cache cho Report print
        let dailyReportCache = []; // (MỚI) Cache cho Lễ tân export

        // Lấy thông tin config từ Canvas (hoặc dùng default)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hba-default-app';
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Đường dẫn collection trên Firestore (dùng chung cho admin/lễ tân)
        const hocVienCollectionPath = `/artifacts/${appId}/public/data/hoc_vien_db`;
        // (MỚI) Đường dẫn settings
        const hlvCollectionPath = `/artifacts/${appId}/public/data/hlv_settings`;
        const paymentSettingsDocPath = `/artifacts/${appId}/public/data/app_settings/payment_info`;

        try {
            const firebaseConfig = JSON.parse(firebaseConfigStr);
            if (!firebaseConfig.apiKey) {
                throw new Error("Firebase config không hợp lệ.");
            }

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug'); // Bật log debug cho Firestore

            // Định nghĩa collection
            dbHocVienCollection = collection(db, hocVienCollectionPath);
            dbHlvCollection = collection(db, hlvCollectionPath);
            dbPaymentSettingsDoc = doc(db, paymentSettingsDocPath);

            // Xác thực người dùng
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User đã đăng nhập:", user.uid);
                    currentUserId = user.uid;
                    document.getElementById('userIdDisplay').textContent = user.uid;
                    
                    // (MỚI) Kiểm tra quyền Admin
                    if (ADMIN_USER_ID_LIST.includes(currentUserId)) {
                        isAdmin = true;
                        // Hiển thị nút gạt Role cho Admin
                        document.getElementById('roleSwitcherWrapper').classList.remove('hidden');
                        console.log("Quyền Admin được cấp.");
                    } else {
                        isAdmin = false;
                        // Ẩn nút gạt (an toàn, mặc định là hidden)
                        document.getElementById('roleSwitcherWrapper').classList.add('hidden');
                        console.log("Quyền Lễ tân (tiêu chuẩn).");
                    }

                    // (MỚI) Thiết lập giao diện ban đầu (lễ tân hay admin)
                    setupInitialView();
                    
                    // Bắt đầu lắng nghe dữ liệu
                    // (MỚI) Phải load settings trước
                    loadAppSettings();
                } else {
                    console.log("User chưa đăng nhập. Đang thử đăng nhập...");
                    signInUser();
                }
            });

        } catch (error) {
            console.error("Lỗi khởi tạo Firebase:", error);
            showMessage("Lỗi khởi tạo hệ thống. Vui lòng tải lại trang.", "error");
        }

        async function signInUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Đăng nhập thành công với Custom Token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Đăng nhập ẩn danh thành công.");
                }
            } catch (error) {
                console.error("Lỗi đăng nhập:", error);
                showMessage("Lỗi xác thực người dùng.", "error");
            }
        }

        // (MỚI) Hàm load settings (HLV + QR) từ Firestore
        async function loadAppSettings() {
            try {
                // 1. Load HLV Settings
                const hlvSnapshot = await getDocs(query(dbHlvCollection));
                HLV_SETTINGS_LIST = []; // Xóa cache cũ
                hlvSnapshot.forEach((doc) => {
                    HLV_SETTINGS_LIST.push({ id: doc.id, ...doc.data() });
                });
                console.log("Loaded HLV Settings:", HLV_SETTINGS_LIST);
                // Sắp xếp theo ưu tiên
                HLV_SETTINGS_LIST.sort((a, b) => a.ca.localeCompare(b.ca) || a.uuTien - b.uuTien);

                // 2. Load Payment Settings
                const paymentSnapshot = await getDoc(dbPaymentSettingsDoc);
                if (paymentSnapshot.exists()) {
                    PAYMENT_SETTINGS = paymentSnapshot.data();
                    console.log("Loaded Payment Settings:", PAYMENT_SETTINGS);
                } else {
                    console.log("Không tìm thấy payment settings, dùng default.");
                    // (MỚI) Nếu không có, tạo 1 cái default
                    PAYMENT_SETTINGS = {
                        bankName: "Vietinbank",
                        bankBin: "970415",
                        accountNumber: "0938099675",
                        accountName: "TRUONG HY MINH"
                    };
                    await setDoc(dbPaymentSettingsDoc, PAYMENT_SETTINGS, { merge: true });
                }

                // 3. Khởi tạo UI (SAU KHI đã load xong)
                initializeUI();
                renderHlvSettingsTable(); // Render bảng HLV settings

                // 4. Bắt đầu lắng nghe dữ liệu học viên
                startRealtimeListener();

            } catch (error) {
                console.error("Lỗi nghiêm trọng khi tải settings:", error);
                showMessage("Lỗi tải cấu hình HLV/Thanh toán. App không thể chạy.", "error");
            }
        }


        /* ===== 4. LẮNG NGHE SỰ KIỆN & UI LOGIC ===== */

        // Lấy các element DOM
        const roleSwitcher = document.getElementById('roleSwitcher');
        const leTanView = document.getElementById('leTanView');
        const adminView = document.getElementById('adminView');

        // Lễ tân form
        const goiHocSelect = document.getElementById('goiHoc');
        const caHocSelect = document.getElementById('caHoc');
        const tenHVInput = document.getElementById('tenHV');
        const hlvDuocGanSpan = document.getElementById('hlvDuocGan');
        const hocPhiTuDongSpan = document.getElementById('hocPhiTuDong');
        const ghiDanhButton = document.getElementById('ghiDanhButton');

        // Admin form
        const adminGoiHocSelect = document.getElementById('adminGoiHoc');
        const adminCaHocSelect = document.getElementById('adminCaHoc');
        const adminHlvChonSelect = document.getElementById('adminHlvChon');
        const adminAddButton = document.getElementById('adminAddButton');
        const adminThanhToan = document.getElementById('adminThanhToan'); // (MỚI)

        // (MỚI) Lễ Tân Stats
        const todayRevenueHeader = document.getElementById('todayRevenueHeader');
        const statTodayCount = document.getElementById('statTodayCount');
        const statWeekCount = document.getElementById('statWeekCount');
        const statMonthCount = document.getElementById('statMonthCount');
        const dailyReportTableBody = document.getElementById('dailyReportTableBody');
        const exportDailyExcelButton = document.getElementById('exportDailyExcelButton');

        // Report
        const reportMonthSelect = document.getElementById('reportMonth');
        const reportYearInput = document.getElementById('reportYear');
        const viewReportButton = document.getElementById('viewReportButton');
        const printReportButton = document.getElementById('printReportButton'); // (MỚI)
        const exportExcelButton = document.getElementById('exportExcelButton'); // (MỚI)
        const reportTableBody = document.getElementById('reportTableBody');
        const reportTableFooter = document.getElementById('reportTableFooter');
        // (MỚI) Report Filters
        const reportFilterType = document.getElementById('reportFilterType');
        const filterMonthControls = document.getElementById('filterMonthControls');
        const filterDateControls = document.getElementById('filterDateControls');
        const filterRangeControls = document.getElementById('filterRangeControls');
        const reportDate = document.getElementById('reportDate');
        const reportDateStart = document.getElementById('reportDateStart');
        const reportDateEnd = document.getElementById('reportDateEnd');

        // History
        const historyTableBody = document.getElementById('historyTableBody');
        
        // (MỚI) HLV Settings form
        const hlvSettingsTableBody = document.getElementById('hlvSettingsTableBody');
        const saveHlvButton = document.getElementById('saveHlvButton');
        
        // (MỚI) QR Settings form
        const saveQrButton = document.getElementById('saveQrButton');
        
        // (MỚI) Excel Import
        const excelImportFile = document.getElementById('excelImportFile');
        const importExcelButton = document.getElementById('importExcelButton');
        
        // (MỚI) Edit Modal
        const editStudentModal = document.getElementById('editStudentModal');
        const updateStudentButton = document.getElementById('updateStudentButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const editGoiHocSelect = document.getElementById('editGoiHoc');
        const editCaHocSelect = document.getElementById('editCaHoc');
        const editHlvChonSelect = document.getElementById('editHlvChon');

        // Message box
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessage = document.getElementById('closeMessage');

        // Hàm khởi tạo: Điền các dropdowns
        function initializeUI() {
            // Xóa dropdowns cũ (phòng khi init lại)
            goiHocSelect.innerHTML = '<option value="">-- Chọn gói học --</option>';
            adminGoiHocSelect.innerHTML = '<option value="">-- Chọn gói học --</option>';
            editGoiHocSelect.innerHTML = '<option value="">-- Chọn gói học --</option>';

            // Điền Gói Học (Lễ Tân + Admin + Edit)
            GOI_HOC_SETTINGS.forEach(goi => {
                const option = `<option value="${goi.ten}" data-hocphi="${goi.hocPhi}">${goi.ten}</option>`;
                goiHocSelect.innerHTML += option;
                adminGoiHocSelect.innerHTML += option;
                editGoiHocSelect.innerHTML += option;
            });

            // Xóa dropdowns cũ
            caHocSelect.innerHTML = '<option value="">-- Chọn ca học --</option>';
            adminCaHocSelect.innerHTML = '<option value="">-- Chọn ca học --</option>';
            editCaHocSelect.innerHTML = '<option value="">-- Chọn ca học --</option>';

            // Điền Ca Học (Lễ Tân + Admin + Edit)
            CA_HOC_SETTINGS.forEach(ca => {
                const option = `<option value="${ca}">${ca}</option>`;
                caHocSelect.innerHTML += option;
                adminCaHocSelect.innerHTML += option;
                editCaHocSelect.innerHTML += option;
            });

            // Xóa dropdowns cũ
            adminHlvChonSelect.innerHTML = '<option value="">-- Chọn HLV --</option>';
            editHlvChonSelect.innerHTML = '<option value="">-- Chọn HLV --</option>';

            // Điền HLV (Admin + Edit) - (MỚI) Từ HLV_SETTINGS_LIST
            HLV_SETTINGS_LIST.forEach(hlv => {
                const option = `<option value="${hlv.ten}">${hlv.ten}</option>`;
                adminHlvChonSelect.innerHTML += option;
                editHlvChonSelect.innerHTML += option;
            });

            // (MỚI) Điền QR Settings
            document.getElementById('qrBankName').value = PAYMENT_SETTINGS.bankName || "";
            document.getElementById('qrBankBin').value = PAYMENT_SETTINGS.bankBin || "";
            document.getElementById('qrAccountNumber').value = PAYMENT_SETTINGS.accountNumber || "";
            document.getElementById('qrAccountName').value = PAYMENT_SETTINGS.accountName || "";

            // Điền Tháng/Năm cho Report
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            for (let i = 1; i <= 12; i++) {
                reportMonthSelect.innerHTML += `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>Tháng ${i}</option>`;
            }
            reportYearInput.value = currentYear;

            // Lắng nghe sự kiện
            roleSwitcher.addEventListener('change', toggleView);
            goiHocSelect.addEventListener('change', updateHocPhi);
            caHocSelect.addEventListener('change', updateHocPhi); // updateHocPhi cũng gọi updateAutoAssignment
            ghiDanhButton.addEventListener('click', handleGhiDanhAndPrint); // (MỚI) Đổi tên hàm
            adminAddButton.addEventListener('click', handleAdminAdd);
            viewReportButton.addEventListener('click', handleViewReport);
            closeMessage.addEventListener('click', () => messageBox.classList.add('hide'));

            // (MỚI) Lắng nghe sự kiện mới
            printReportButton.addEventListener('click', handlePrintReport);
            exportExcelButton.addEventListener('click', handleExportExcel);
            exportDailyExcelButton.addEventListener('click', handleExportDailyExcel); // (MỚI)
            saveHlvButton.addEventListener('click', handleSaveHlv);
            saveQrButton.addEventListener('click', handleSaveQr);
            importExcelButton.addEventListener('click', handleImportExcel); // (MỚI)
            updateStudentButton.addEventListener('click', handleUpdateStudent);
            cancelEditButton.addEventListener('click', () => editStudentModal.classList.add('hidden'));
            reportFilterType.addEventListener('change', toggleReportFilter); // (MỚI)

            // (MỚI) Lắng nghe sự kiện click trên bảng (Event Delegation)
            historyTableBody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const id = target.dataset.id;
                if (target.classList.contains('edit-btn')) {
                    handleShowEditModal(id);
                } else if (target.classList.contains('delete-btn')) {
                    const name = target.dataset.name;
                    handleDeleteStudent(id, name);
                }
            });

            hlvSettingsTableBody.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const id = target.dataset.id;
                if (target.classList.contains('edit-hlv-btn')) {
                    handleEditHlv(id);
                } else if (target.classList.contains('delete-hlv-btn')) {
                    handleDeleteHlv(id);
                }
            });
        }

        // (MỚI) Hàm thiết lập View (thay thế toggleView)
        function setupInitialView() {
            let currentRole = 'leTan'; // Mặc định là Lễ tân

            if (isAdmin) {
                // Nếu là Admin, đọc giá trị từ nút gạt
                currentRole = roleSwitcher.value;
            }

            if (currentRole === 'admin') {
                leTanView.classList.add('hidden');
                adminView.classList.remove('hidden');
                document.body.classList.add('admin-view'); // (MỚI) Thêm class vào body
                document.body.classList.remove('le-tan-view');
            } else {
                leTanView.classList.remove('hidden');
                adminView.classList.add('hidden');
                document.body.classList.remove('admin-view');
                document.body.classList.add('le-tan-view'); // (MỚI) Thêm class vào body
            }
            
            // (MỚI) Gán ngày mặc định cho các bộ lọc
            const todayISO = new Date().toISOString().split('T')[0];
            reportDate.value = todayISO;
            reportDateStart.value = todayISO;
            reportDateEnd.value = todayISO;
        }

        // Chuyển đổi view Admin/Lễ Tân (MỚI: chỉ gọi setupInitialView)
        function toggleView() {
            setupInitialView();
        }

        // (SỬA) Bổ sung hàm updateHocPhi
        function updateHocPhi() {
            const selectedGoiOption = goiHocSelect.options[goiHocSelect.selectedIndex];
            let hocPhi = 0;
            if (selectedGoiOption && selectedGoiOption.dataset.hocphi) {
                hocPhi = Number(selectedGoiOption.dataset.hocphi);
            }
            
            const formatter = new Intl.NumberFormat('vi-VN');
            hocPhiTuDongSpan.textContent = `${formatter.format(hocPhi)} VNĐ`;
            
            // Gọi gán HLV
            updateAutoAssignment();
        }

        /* ===== 5. LOGIC NGHIỆP VỤ CHÍNH (GÁN HLV) ===== */

        // Hàm tìm HLV tiếp theo
        async function getNextHlv(caHoc) {
            if (!caHoc) {
                return "Vui lòng chọn Ca Học";
            }

            try {
                // 1. Lọc HLV trong ca (MỚI: Dùng HLV_SETTINGS_LIST)
                const hlvInCa = HLV_SETTINGS_LIST.filter(hlv => hlv.ca === caHoc);
                if (hlvInCa.length === 0) return "Không có HLV cho ca này";

                // 2. Lấy tất cả HĐ "Thường" trong ca này từ Firestore
                const q = query(dbHocVienCollection, where("loaiHD", "==", "Thường"), where("caHoc", "==", caHoc));
                const querySnapshot = await getDocs(q);
                const thuongRegistrations = querySnapshot.docs.map(doc => doc.data());

                // 3. Đếm số lượt của mỗi HLV
                let hlvCounts = hlvInCa.map(hlv => ({
                    ...hlv,
                    count: 0
                }));

                thuongRegistrations.forEach(reg => {
                    const hlvIndex = hlvCounts.findIndex(hlv => hlv.ten === reg.hlvPhuTrach);
                    if (hlvIndex > -1) {
                        hlvCounts[hlvIndex].count++;
                    }
                });

                // 4. Tìm số lượt ít nhất (MIN)
                const minCount = Math.min(...hlvCounts.map(hlv => hlv.count));

                // 5. Lọc ra các HLV có số lượt = MIN
                const candidates = hlvCounts.filter(hlv => hlv.count === minCount);

                // 6. Sắp xếp các HLV này theo "Ưu tiên" (Tie-break)
                candidates.sort((a, b) => a.uuTien - b.uuTien);

                // 7. Người thắng là người đầu tiên
                return candidates[0].ten;

            } catch (error) {
                console.error("Lỗi khi lấy HLV tiếp theo:", error);
                showMessage("Lỗi khi tính toán HLV. Vui lòng thử lại.", "error");
                return "Lỗi... Thử lại";
            }
        }

        // Cập nhật UI HLV tự động
        async function updateAutoAssignment() {
            const selectedCa = caHocSelect.value;
            hlvDuocGanSpan.textContent = "Đang tính toán...";
            const nextHlv = await getNextHlv(selectedCa);
            hlvDuocGanSpan.textContent = nextHlv;
        }

        // Xử lý Ghi Danh (Lễ Tân) (MỚI: Đổi tên + In phiếu)
        async function handleGhiDanhAndPrint() {
            if (!currentUserId) {
                showMessage("Lỗi xác thực. Vui lòng tải lại trang.", "error");
                return;
            }

            // Lấy dữ liệu
            const tenHV = tenHVInput.value;
            const selectedGoiOption = goiHocSelect.options[goiHocSelect.selectedIndex];
            const goiHoc = selectedGoiOption.value;
            const hocPhi = Number(selectedGoiOption.dataset.hocphi);
            const caHoc = caHocSelect.value;
            const hlvDuocGan = hlvDuocGanSpan.textContent;
            const thanhToan = document.getElementById('thanhToan').value; // (MỚI)

            // Kiểm tra
            if (!tenHV || !goiHoc || !caHoc || !thanhToan || hlvDuocGan.includes("Vui lòng") || hlvDuocGan.includes("Lỗi")) {
                showMessage("Vui lòng nhập đầy đủ thông tin (Tên, Gói, Ca, Thanh toán).", "warning");
                return;
            }

            // Hiển thị loading
            ghiDanhButton.disabled = true;
            document.getElementById('ghiDanhText').classList.add('hidden');
            document.getElementById('ghiDanhLoading').classList.remove('hidden');

            // Tạo object
            const newRegistration = {
                timestamp: Timestamp.now(),
                tenHV: tenHV,
                goiHoc: goiHoc,
                caHoc: caHoc,
                hlvPhuTrach: hlvDuocGan,
                loaiHD: "Thường",
                ghiChu: "",
                hocPhi: hocPhi,
                thanhToan: thanhToan, // (MỚI)
                addedByUserId: currentUserId
            };

            // Lưu vào Firestore
            try {
                const docRef = await addDoc(dbHocVienCollection, newRegistration);
                showMessage("Ghi danh thành công! Đang chuẩn bị phiếu...", "success");
                
                // (MỚI) In phiếu
                printRegistrationSlip({ ...newRegistration, id: docRef.id });

                // Xóa form
                tenHVInput.value = "";
                goiHocSelect.selectedIndex = 0;
                caHocSelect.selectedIndex = 0;
                hlvDuocGanSpan.textContent = "Vui lòng chọn Ca Học";
                hocPhiTuDongSpan.textContent = "0 VNĐ";
            } catch (error) {
                console.error("Lỗi ghi danh:", error);
                showMessage("Lỗi khi lưu dữ liệu. Vui lòng thử lại.", "error");
            } finally {
                // Tắt loading
                ghiDanhButton.disabled = false;
                document.getElementById('ghiDanhText').classList.remove('hidden');
                document.getElementById('ghiDanhLoading').classList.add('hidden');
            }
        }
        
        /* ===== 6. LOGIC ADMIN (GHI ĐÈ & BÁO CÁO) ===== */

        // Xử lý Thêm HĐ (Admin)
        async function handleAdminAdd() {
            if (!currentUserId) {
                showMessage("Lỗi xác thực. Vui lòng tải lại trang.", "error");
                return;
            }
            
            // Lấy dữ liệu
            const tenHV = document.getElementById('adminTenHV').value;
            const selectedGoiOption = adminGoiHocSelect.options[adminGoiHocSelect.selectedIndex];
            const goiHoc = selectedGoiOption.value;
            const hocPhi = Number(selectedGoiOption.dataset.hocphi);
            const caHoc = adminCaHocSelect.value;
            const hlvPhuTrach = adminHlvChonSelect.value;
            const loaiHD = document.getElementById('adminLoaiHD').value;
            const ghiChu = document.getElementById('adminGhiChu').value;
            const thanhToan = document.getElementById('adminThanhToan').value; // (MỚI)

            // Kiểm tra
            if (!tenHV || !goiHoc || !caHoc || !hlvPhuTrach || !thanhToan) {
                showMessage("Vui lòng nhập đầy đủ thông tin (Tên, Gói, Ca, HLV, Thanh toán).", "warning");
                return;
            }
            
            const newRegistration = {
                timestamp: Timestamp.now(),
                tenHV: tenHV,
                goiHoc: goiHoc,
                caHoc: caHoc,
                hlvPhuTrach: hlvPhuTrach,
                loaiHD: loaiHD,
                ghiChu: ghiChu,
                hocPhi: hocPhi,
                thanhToan: thanhToan, // (MỚI)
                addedByUserId: currentUserId
            };
            
            // Lưu vào Firestore
            try {
                // (SỬA) Sửa dbCollection thành dbHocVienCollection
                await addDoc(dbHocVienCollection, newRegistration);
                showMessage("Admin đã thêm HĐ thành công!", "success");
                // Xóa form
                document.getElementById('adminTenHV').value = "";
                adminGoiHocSelect.selectedIndex = 0;
                adminCaHocSelect.selectedIndex = 0;
                adminHlvChonSelect.selectedIndex = 0;
                document.getElementById('adminGhiChu').value = "";
            } catch (error) {
                console.error("Lỗi admin thêm HĐ:", error);
                showMessage("Lỗi khi lưu dữ liệu. Vui lòng thử lại.", "error");
            }
        }

        // (MỚI) Hàm chuyển đổi UI bộ lọc báo cáo
        function toggleReportFilter() {
            const filterType = reportFilterType.value;
            filterMonthControls.classList.toggle('hidden', filterType !== 'month');
            filterDateControls.classList.toggle('hidden', filterType !== 'date');
            filterRangeControls.classList.toggle('hidden', filterType !== 'range');
        }

        // Xử lý Xem Báo Cáo (MỚI: Nâng cấp)
        async function handleViewReport() {
            const filterType = reportFilterType.value;
            let startOfPeriod, endOfPeriod;
            let reportTitle = "";

            try {
                // (MỚI) Tính toán khoảng thời gian dựa trên bộ lọc
                if (filterType === 'month') {
                    const month = parseInt(reportMonthSelect.value);
                    const year = parseInt(reportYearInput.value);
                    if (!month || !year) throw new Error("Tháng hoặc Năm không hợp lệ.");
                    
                    startOfPeriod = Timestamp.fromDate(new Date(year, month - 1, 1, 0, 0, 0));
                    endOfPeriod = Timestamp.fromDate(new Date(new Date(year, month, 1).getTime() - 1));
                    reportTitle = `Tháng ${month}/${year}`;

                } else if (filterType === 'today') {
                    const now = new Date();
                    startOfPeriod = Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0));
                    endOfPeriod = Timestamp.fromDate(new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999));
                    reportTitle = `Hôm Nay (${now.toLocaleDateString('vi-VN')})`;

                } else if (filterType === 'date') {
                    if (!reportDate.value) throw new Error("Vui lòng chọn ngày.");
                    const date = new Date(reportDate.value);
                    startOfPeriod = Timestamp.fromDate(new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0));
                    endOfPeriod = Timestamp.fromDate(new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59, 999));
                    reportTitle = `Ngày ${date.toLocaleDateString('vi-VN')}`;

                } else if (filterType === 'range') {
                    if (!reportDateStart.value || !reportDateEnd.value) throw new Error("Vui lòng chọn ngày bắt đầu và kết thúc.");
                    const start = new Date(reportDateStart.value);
                    const end = new Date(reportDateEnd.value);
                    
                    startOfPeriod = Timestamp.fromDate(new Date(start.getFullYear(), start.getMonth(), start.getDate(), 0, 0, 0));
                    endOfPeriod = Timestamp.fromDate(new Date(end.getFullYear(), end.getMonth(), end.getDate(), 23, 59, 59, 999));
                    reportTitle = `Từ ${start.toLocaleDateString('vi-VN')} đến ${end.toLocaleDateString('vi-VN')}`;
                }

                // Query
                const q = query(dbHocVienCollection, 
                    where("timestamp", ">=", startOfPeriod), 
                    where("timestamp", "<=", endOfPeriod)
                );
                
                const querySnapshot = await getDocs(q);
                const registrations = querySnapshot.docs.map(doc => doc.data());
                
                if (registrations.length === 0) {
                    reportTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Không tìm thấy dữ liệu cho: ${reportTitle}.</td></tr>`;
                    reportTableFooter.classList.add('hidden');
                    currentReportCache = []; // Xóa cache
                    return;
                }
                
                // ... (Phần còn lại của hàm xử lý và render)
                let reportData = {};
                HLV_SETTINGS_LIST.forEach(hlv => {
                    reportData[hlv.ten] = { ten: hlv.ten, count: 0, totalRevenue: 0 };
                });
                
                registrations.forEach(reg => {
                    if (reportData[reg.hlvPhuTrach]) {
                        reportData[reg.hlvPhuTrach].count++;
                        reportData[reg.hlvPhuTrach].totalRevenue += reg.hocPhi;
                    }
                });

                let reportArray = Object.values(reportData).sort((a, b) => b.totalRevenue - a.totalRevenue);
                
                currentReportCache = { title: reportTitle, data: reportArray }; // (MỚI) Lưu cache để in
                renderReportTable(reportArray);

            } catch (error) {
                console.error("Lỗi khi xem báo cáo:", error);
                showMessage(error.message || "Lỗi khi tải dữ liệu báo cáo.", "error");
            }
        }
        
        /* ===== 7. LẮNG NGHE REALTIME (DATABASE HISTORY) ===== */
        
        function startRealtimeListener() {
            if (!dbHocVienCollection) return;
            
            // Theo hướng dẫn, không dùng orderBy để tránh lỗi index
            // Sẽ sort trong memory
            const q = query(dbHocVienCollection); 

            onSnapshot(q, (querySnapshot) => {
                let allDocs = [];
                querySnapshot.forEach((doc) => {
                    allDocs.push({ id: doc.id, ...doc.data() }); // (MỚI) Lưu cả ID
                });

                // Sắp xếp trong memory (mới nhất lên đầu)
                allDocs.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                
                allStudentsCache = allDocs; // (MỚI) Lưu cache cho Excel

                // (MỚI) Tính toán Stats và Doanh thu
                updateDashboardStats(allDocs);

                // Render lịch sử
                renderHistoryTable(allDocs);
                
                // Cập nhật lại HLV (nếu đang ở view Lễ Tân)
                // Điều này đảm bảo HLV được gán luôn là HLV mới nhất
                if (leTanView.offsetParent !== null) { // Kiểm tra xem view Lễ Tân có đang hiển thị không
                    updateAutoAssignment();
                }

            }, (error) => {
                console.error("Lỗi khi lắng nghe real-time:", error);
                showMessage("Mất kết nối real-time.", "error");
            });
        }
        
        function renderHistoryTable(data) {
            historyTableBody.innerHTML = "";
            const formatter = new Intl.NumberFormat('vi-VN');

            if (data.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Chưa có dữ liệu.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const timestamp = item.timestamp.toDate().toLocaleString('vi-VN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const loaiHDClass = item.loaiHD === 'Chỉ Định' ? 'text-red-600 font-bold' : 'text-gray-500';

                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${timestamp}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.tenHV}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.hlvPhuTrach}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.goiHoc}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatter.format(item.hocPhi)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${loaiHDClass}">${item.loaiHD}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.thanhToan || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.ghiChu}</td>
                        <!-- (MỚI) Thêm class 'admin-only' -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium admin-only">
                            <button class="text-blue-600 hover:text-blue-900 edit-btn" data-id="${item.id}">Sửa</button>
                            <button class="text-red-600 hover:text-red-900 ml-4 delete-btn" data-id="${item.id}" data-name="${item.tenHV}">Xóa</button>
                        </td>
                    </tr>
                `;
                historyTableBody.innerHTML += row;
            });
        }
        
        /* ===== 8. HÀM TIỆN ÍCH (MESSAGE BOX) ===== */
        
        let messageTimer;
        function showMessage(text, type = 'success') {
            messageText.textContent = text;
            
            // Xóa các class màu cũ
            messageBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-400', 'text-white', 'text-gray-800');
            messageBox.classList.add('hide'); // Reset animation

            if (type === 'success') {
                messageBox.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500', 'text-white');
            } else if (type === 'warning') {
                messageBox.classList.add('bg-yellow-400', 'text-gray-800');
            }

            messageBox.classList.remove('hidden', 'hide');

            // Tự động ẩn sau 3 giây
            clearTimeout(messageTimer);
            messageTimer = setTimeout(() => {
                messageBox.classList.add('hide');
            }, 3000);
        }

        /* ===== 9. CHẠY KHỞI TẠO ===== */
        // (MỚI) Đã chuyển hàm initializeUI() vào sau khi loadAppSettings() thành công
        // initializeUI(); // Xóa dòng này

        /* ===== 10. (MỚI) CÁC HÀM CRUD (SỬA/XÓA) VÀ IN ẤN ===== */

        // (MỚI) Tính toán Stats Bảng điều khiển
        function updateDashboardStats(allDocs) {
            const now = new Date();
            const formatter = new Intl.NumberFormat('vi-VN');

            // Xác định các mốc thời gian
            const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
            const endToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
            
            // Tính ngày đầu tuần (Chủ Nhật là 0)
            const firstDayOfWeek = new Date(now);
            firstDayOfWeek.setDate(now.getDate() - now.getDay());
            firstDayOfWeek.setHours(0, 0, 0, 0);
            
            const startMonth = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
            
            let todayRevenue = 0;
            let todayCount = 0;
            let weekCount = 0;
            let monthCount = 0;
            let todayDocs = [];

            // Lọc dữ liệu (dùng array filter nhanh hơn)
            for (const doc of allDocs) {
                const docTime = doc.timestamp.toDate();
                
                // Tính cho hôm nay
                if (docTime >= startToday && docTime <= endToday) {
                    todayRevenue += doc.hocPhi;
                    todayCount++;
                    todayDocs.push(doc); // Thêm vào báo cáo Lễ tân
                }
                // Tính cho tuần
                if (docTime >= firstDayOfWeek) {
                    weekCount++;
                }
                // Tính cho tháng
                if (docTime >= startMonth) {
                    monthCount++;
                }
            }
            
            // Cập nhật UI
            todayRevenueHeader.textContent = `${formatter.format(todayRevenue)} VNĐ`;
            statTodayCount.textContent = todayCount;
            statWeekCount.textContent = weekCount;
            statMonthCount.textContent = monthCount;

            // Cập nhật Báo cáo Lễ tân
            renderDailyReportTable(todayDocs);
            dailyReportCache = todayDocs; // Lưu cache cho Lễ tân export
        }
        
        // (MỚI) Render Báo cáo Lễ Tân
        function renderDailyReportTable(todayDocs) {
            dailyReportTableBody.innerHTML = "";
            const formatter = new Intl.NumberFormat('vi-VN');
            if (todayDocs.length === 0) {
                dailyReportTableBody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-center text-gray-500">Chưa có HV mới hôm nay.</td></tr>`;
                return;
            }
            todayDocs.forEach(item => { // Sắp xếp theo thời gian mới nhất
                const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.tenHV}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${formatter.format(item.hocPhi)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${item.hlvPhuTrach}</td>
                    </tr>
                `;
                dailyReportTableBody.innerHTML += row;
            });
        }


        // ----- Chức năng In Phiếu Ghi Danh -----
        function printRegistrationSlip(regData) {
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            const formatter = new Intl.NumberFormat('vi-VN');
            const now = new Date().toLocaleString('vi-VN');

            // (MỚI) Tạo VietQR String
            // Chuẩn 000201 (QR tĩnh) 010212 (QR động)
            // 000201
            // 010211 (QR động 1 lần)
            // 38 (GUID)
            //   00 (GUID VN) 0010A000000727
            //   01 (Service) 0006970415
            //   02 (Account) 00080938099675
            // 53 (Currency) 0003704
            // 54 (Amount) 00(len)(amount) -> 5406150000
            // 62 (Add Info)
            //   01 (len)(Ma GD) -> 01(len)HBA(id)
            //   08 (len)(Noi dung) -> 08(len)Thanh toan
            // 63 (CRC) 0004(CRC)
            
            // TẠM THỜI: Dùng QR đơn giản chỉ chứa STK + Tên + Bank để tương thích nhiều app
            // Hoặc dùng link của Google Charts API
            
            // Tạm thời dùng QR đơn giản nhất: Chỉ STK
            // const qrData = PAYMENT_SETTINGS.accountNumber; 
            
            // Dùng chuẩn VietQR (compact) để nhiều app ngân hàng quét được
            const qrText = `https://api.vietqr.io/image/${PAYMENT_SETTINGS.bankBin}-${PAYMENT_SETTINGS.accountNumber}-compact.png?amount=${regData.hocPhi}&addInfo=HBA Q6 ${regData.tenHV.split(' ').pop()}`;
            
            const content = `
                <html>
                <head>
                    <title>Phiếu Ghi Danh ${regData.tenHV}</title>
                    <style>
                        ${document.querySelector('style[media="print"]').innerHTML} /* Copy style in */
                        #qr-code-placeholder { width: 200px; height: 200px; margin: 10px auto; }
                    </style>
                </head>
                <body class="print-container">
                    <div class="print-header">
                        <h1>HỒ BƠI HBA QUẬN 6</h1>
                        <p>Phiếu Ghi Danh & Thu Phí</p>
                        <p>Ngày giờ: ${now}</p>
                    </div>

                    <table class="print-table">
                        <tr><td style="width: 200px;">Học viên:</td><td><strong>${regData.tenHV}</strong></td></tr>
                        <tr><td>Gói học:</td><td>${regData.goiHoc}</td></tr>
                        <tr><td>Học phí:</td><td><strong>${formatter.format(regData.hocPhi)} VNĐ</strong></td></tr>
                        <tr><td>HLV Phụ trách:</td><td>${regData.hlvPhuTrach}</td></tr>
                        <tr><td>Hình thức:</td><td>${regData.thanhToan}</td></tr>
                    </table>

                    ${regData.thanhToan === 'Chuyển khoản' ? `
                    <div class="print-qr">
                        <p>Quét mã QR để thanh toán (App Ngân hàng)</p>
                        <img src="${qrText}" alt="QR Code Thanh toán" style="width: 200px; height: 200px;" />
                        <div id="qr-code-placeholder"></div>
                        <p style="font-size: 14px; margin-top: 10px;">
                            Ngân hàng: <strong>${PAYMENT_SETTINGS.bankName}</strong><br>
                            STK: <strong>${PAYMENT_SETTINGS.accountNumber}</strong><br>
                            Chủ TK: <strong>${PAYMENT_SETTINGS.accountName}</strong><br>
                            Nội dung: (Tên HV) - (SĐT)
                        </p>
                    </div>
                    ` : '<p style="margin-top: 20px;">Vui lòng thu tiền mặt.</p>'}

                    <div class="print-footer">
                        <span>Người lập phiếu</span>
                        <span>Học viên / Phụ huynh</span>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(content);
            
            // (MỚI) Dùng qrcode.js để tạo QR (ổn định hơn dùng link api.vietqr.io)
            // if (regData.thanhToan === 'Chuyển khoản') {
            //    Tạo chuỗi VietQR
            //    const vietQRString = `00020101021238570010A00000072701${PAYMENT_SETTINGS.bankBin.length}${PAYMENT_SETTINGS.bankBin}02${String(PAYMENT_SETTINGS.accountNumber).length}${PAYMENT_SETTINGS.accountNumber}5303704540${String(regData.hocPhi).length}${regData.hocPhi}5802VN62150811HBA ${regData.tenHV}6304`;
            //    const qrPlaceholder = printWindow.document.getElementById('qr-code-placeholder');
            //    new QRCode(qrPlaceholder, {
            //        text: vietQRString, // "00020101021238570010A0000007270110970415020809380996755303704540715000005802VN62150811HBA Test6304" + Dùng hàm tính CRC16
            //        width: 180,
            //        height: 180
            //    });
            // }

            printWindow.document.close(); // Bắt buộc cho IE
            printWindow.focus(); // Bắt buộc cho Safari
            
            // Chờ ảnh QR tải xong (nếu dùng link)
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500); // Đợi 0.5 giây
        }

        // ----- Chức năng Sửa/Xóa Học viên -----
        async function handleShowEditModal(docId) {
            try {
                const docRef = doc(dbHocVienCollection, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('editStudentId').value = docId;
                    document.getElementById('editTenHV').value = data.tenHV;
                    document.getElementById('editGoiHoc').value = data.goiHoc;
                    document.getElementById('editCaHoc').value = data.caHoc;
                    document.getElementById('editHlvChon').value = data.hlvPhuTrach;
                    document.getElementById('editLoaiHD').value = data.loaiHD;
                    document.getElementById('editThanhToan').value = data.thanhToan || 'Tiền mặt';
                    document.getElementById('editGhiChu').value = data.ghiChu;
                    
                    editStudentModal.classList.remove('hidden');
                } else {
                    showMessage("Không tìm thấy học viên.", "error");
                }
            } catch (error) {
                console.error("Lỗi khi lấy thông tin sửa:", error);
                showMessage("Lỗi tải dữ liệu để sửa.", "error");
            }
        }

        async function handleUpdateStudent() {
            const docId = document.getElementById('editStudentId').value;
            if (!docId) return;

            // Lấy học phí mới
            const selectedGoiOption = editGoiHocSelect.options[editGoiHocSelect.selectedIndex];
            const hocPhi = Number(selectedGoiOption.dataset.hocphi);

            const updatedData = {
                tenHV: document.getElementById('editTenHV').value,
                goiHoc: document.getElementById('editGoiHoc').value,
                caHoc: document.getElementById('editCaHoc').value,
                hlvPhuTrach: document.getElementById('editHlvChon').value,
                loaiHD: document.getElementById('editLoaiHD').value,
                thanhToan: document.getElementById('editThanhToan').value,
                ghiChu: document.getElementById('editGhiChu').value,
                hocPhi: hocPhi
            };

            try {
                const docRef = doc(dbHocVienCollection, docId);
                await updateDoc(docRef, updatedData);
                showMessage("Cập nhật học viên thành công!", "success");
                editStudentModal.classList.add('hidden');
            } catch (error) {
                console.error("Lỗi khi cập nhật:", error);
                showMessage("Lỗi lưu thay đổi.", "error");
            }
        }

        async function handleDeleteStudent(docId, tenHV) {
            // (QUAN TRỌNG) Không dùng window.confirm
            // Tạo 1 message box tùy chỉnh (tuy nhiên để đơn giản, admin nên cẩn thận)
            // Tạm thời, chúng ta sẽ xóa trực tiếp (admin đã được cảnh báo)
            // if (prompt(`Gõ 'XOA' để xác nhận xóa học viên ${tenHV}`) !== 'XOA') {
            //     showMessage("Hủy xóa.", "warning");
            //     return;
            // }
            // Tạm thời bỏ qua confirm() vì quy định
            
            try {
                await deleteDoc(doc(dbHocVienCollection, docId));
                showMessage(`Đã xóa học viên ${tenHV}.`, "success");
            } catch (error) {
                console.error("Lỗi khi xóa:", error);
                showMessage("Lỗi khi xóa học viên.", "error");
            }
        }

        // ----- Chức năng In/Export Báo Cáo -----
        function handlePrintReport() {
            if (!currentReportCache.data || currentReportCache.data.length === 0) {
                showMessage("Không có dữ liệu báo cáo để in.", "warning");
                return;
            }
            
            const title = currentReportCache.title || "Báo Cáo Doanh Thu";
            const reportHtml = document.getElementById('reportTableBody').innerHTML;
            const footerHtml = document.getElementById('reportTableFooter').innerHTML;
            const headerHtml = document.querySelector('#adminView .bg-white thead').innerHTML;

            const content = `
                <html><head><title>Báo Cáo Doanh Thu ${month}/${year}</title>
                <style>
                    ${document.querySelector('style[media="print"]').innerHTML}
                    .print-table th, .print-table td { font-size: 12px; }
                </style>
                </head>
                <body class="print-container">
                    <div class="print-header">
                        <h1>${title}</h1>
                    </div>
                    <table class="print-table">
                        <thead>${headerHtml}</thead>
                        <tbody>${reportHtml}</tbody>
                        <tfoot style="background-color: #f4f4f4; font-weight: bold;">${footerHtml}</tfoot>
                    </table>
                </body></html>
            `;
            
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function handleExportExcel() {
            if (allStudentsCache.length === 0) {
                showMessage("Không có dữ liệu để export.", "warning");
                return;
            }

            // Dọn dẹp dữ liệu (chỉ export các cột cần thiết)
            const dataToExport = allStudentsCache.map(item => ({
                'Thời gian': item.timestamp.toDate().toLocaleString('vi-VN'),
                'Tên Học Viên': item.tenHV,
                'HLV Phụ Trách': item.hlvPhuTrach,
                'Gói Học': item.goiHoc,
                'Học Phí': item.hocPhi,
                'Loại HĐ': item.loaiHD,
                'Thanh Toán': item.thanhToan,
                'Ghi Chú': item.ghiChu,
                'Ca Học': item.caHoc
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DanhSachHocVien");
            XLSX.writeFile(wb, `HBA_DanhSachHocVien_Full_${new Date().toISOString().split('T')[0]}.xlsx`);
            showMessage("Đang tải file Excel...", "success");
        }
        
        // (MỚI) Export Excel (Lễ Tân - Hàng ngày)
        function handleExportDailyExcel() {
            if (dailyReportCache.length === 0) {
                showMessage("Không có dữ liệu hôm nay để export.", "warning");
                return;
            }

            const dataToExport = dailyReportCache.map(item => ({
                'Thời gian': item.timestamp.toDate().toLocaleString('vi-VN'),
                'Tên Học Viên': item.tenHV,
                'HLV Phụ Trách': item.hlvPhuTrach,
                'Gói Học': item.goiHoc,
                'Học Phí': item.hocPhi,
                'Loại HĐ': item.loaiHD,
                'Thanh Toán': item.thanhToan,
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoHomNay");
            XLSX.writeFile(wb, `HBA_BaoCaoNgay_${new Date().toISOString().split('T')[0]}.xlsx`);
            showMessage("Đang tải file Excel (Hôm nay)...", "success");
        }
        
        // (MỚI) Import Excel (Admin)
        async function handleImportExcel() {
            const file = excelImportFile.files[0];
            if (!file) {
                showMessage("Vui lòng chọn một file Excel.", "warning");
                return;
            }

            const importButton = importExcelButton;
            const importText = document.getElementById('importExcelText');
            const importLoading = document.getElementById('importExcelLoading');

            importButton.disabled = true;
            importText.classList.add('hidden');
            importLoading.classList.remove('hidden');

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);

                    if (jsonData.length === 0) {
                        throw new Error("File Excel rỗng hoặc sai định dạng.");
                    }

                    let importedCount = 0;
                    for (const row of jsonData) {
                        // Kiểm tra các cột tối thiểu
                        if (!row.tenHV || !row.hlvPhuTrach || !row.hocPhi || !row.caHoc || !row.goiHoc || !row.loaiHD || !row.thanhToan) {
                            console.warn("Bỏ qua dòng (thiếu dữ liệu):", row);
                            continue;
                        }

                        const newRegistration = {
                            timestamp: Timestamp.now(),
                            tenHV: row.tenHV,
                            goiHoc: row.goiHoc,
                            caHoc: row.caHoc,
                            hlvPhuTrach: row.hlvPhuTrach,
                            loaiHD: row.loaiHD, // (Thường, Chỉ Định)
                            ghiChu: row.ghiChu || "Imported",
                            hocPhi: Number(row.hocPhi),
                            thanhToan: row.thanhToan,
                            addedByUserId: currentUserId
                        };

                        await addDoc(dbHocVienCollection, newRegistration);
                        importedCount++;
                    }
                    showMessage(`Import thành công ${importedCount}/${jsonData.length} học viên.`, "success");
                };
                
                reader.onerror = (e) => { throw new Error("Không thể đọc file."); };
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error("Lỗi khi import Excel:", error);
                showMessage(error.message || "Lỗi khi import file.", "error");
            } finally {
                importButton.disabled = false;
                importText.classList.remove('hidden');
                importLoading.classList.add('hidden');
                excelImportFile.value = ""; // Reset input
            }
        }


        // ----- Chức năng Quản lý HLV & Settings -----
        function renderHlvSettingsTable() {
            hlvSettingsTableBody.innerHTML = "";
            HLV_SETTINGS_LIST.forEach(hlv => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${hlv.ten}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${hlv.ca}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${hlv.uuTien}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 edit-hlv-btn" data-id="${hlv.id}">Sửa</button>
                            <button class="text-red-600 hover:text-red-900 ml-4 delete-hlv-btn" data-id="${hlv.id}">Xóa</button>
                        </td>
                    </tr>
                `;
                hlvSettingsTableBody.innerHTML += row;
            });
            // (MỚI) Sau khi render lại bảng, phải cập nhật lại các dropdown chọn HLV
            updateHlvDropdowns();
        }
        
        // (MỚI) Hàm cập nhật lại các dropdown HLV (sau khi sửa HLV settings)
        function updateHlvDropdowns() {
            adminHlvChonSelect.innerHTML = '<option value="">-- Chọn HLV --</option>';
            editHlvChonSelect.innerHTML = '<option value="">-- Chọn HLV --</option>';
            HLV_SETTINGS_LIST.forEach(hlv => {
                const option = `<option value="${hlv.ten}">${hlv.ten}</option>`;
                adminHlvChonSelect.innerHTML += option;
                editHlvChonSelect.innerHTML += option;
            });
        }

        function handleEditHlv(docId) {
            const hlv = HLV_SETTINGS_LIST.find(h => h.id === docId);
            if (hlv) {
                document.getElementById('hlvEditId').value = hlv.id;
                document.getElementById('hlvTen').value = hlv.ten;
                document.getElementById('hlvCa').value = hlv.ca;
                document.getElementById('hlvUuTien').value = hlv.uuTien;
            }
        }

        async function handleSaveHlv() {
            const ten = document.getElementById('hlvTen').value;
            const ca = document.getElementById('hlvCa').value;
            const uuTien = parseInt(document.getElementById('hlvUuTien').value);
            const editId = document.getElementById('hlvEditId').value;

            if (!ten || !ca || isNaN(uuTien)) {
                showMessage("Vui lòng nhập đủ Tên, Ca, Ưu tiên cho HLV.", "warning");
                return;
            }

            const hlvData = { ten, ca, uuTien };

            try {
                if (editId) {
                    // Cập nhật
                    await updateDoc(doc(dbHlvCollection, editId), hlvData);
                    showMessage("Cập nhật HLV thành công!", "success");
                } else {
                    // Thêm mới
                    await addDoc(dbHlvCollection, hlvData);
                    showMessage("Thêm HLV mới thành công!", "success");
                }
                
                document.getElementById('hlvEditId').value = "";
                document.getElementById('hlvTen').value = "";
                document.getElementById('hlvUuTien').value = "";
                
                // Tải lại settings (để refresh bảng và dropdowns)
                loadAppSettings(); 
            } catch (error) {
                console.error("Lỗi lưu HLV:", error);
                showMessage("Lỗi lưu HLV.", "error");
            }
        }

        async function handleDeleteHlv(docId) {
            try {
                await deleteDoc(doc(dbHlvCollection, docId));
                showMessage("Đã xóa HLV.", "success");
                loadAppSettings(); // Tải lại settings
            } catch (error) {
                console.error("Lỗi xóa HLV:", error);
                showMessage("Lỗi xóa HLV.", "error");
            }
        }

        async function handleSaveQr() {
            const qrData = {
                bankName: document.getElementById('qrBankName').value,
                bankBin: document.getElementById('qrBankBin').value,
                accountNumber: document.getElementById('qrAccountNumber').value,
                accountName: document.getElementById('qrAccountName').value
            };

            try {
                await setDoc(dbPaymentSettingsDoc, qrData, { merge: true });
                PAYMENT_SETTINGS = qrData; // Cập nhật cache
                showMessage("Lưu cài đặt QR thành công!", "success");
            } catch (error) {
                console.error("Lỗi lưu QR settings:", error);
                showMessage("Lỗi lưu cài đặt QR.", "error");
            }
        }

    </script>
</body>
</html>